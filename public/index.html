<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Arbitrage Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #111;
            --sidebar-bg: #0a0a0a;
            --text-main: #e0e0e0;
            --text-sub: #777;
            --accent: #00d4ff;
            --accent-dim: rgba(0, 212, 255, 0.1);
            --positive: #10b981;
            --negative: #ef4444;
            --border: rgba(255, 255, 255, 0.06);
            --neon-line: 1px solid var(--accent);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* LAYOUT */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* SIDEBAR */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding-bottom: 70px;
            /* Space for bottom nav if needed, though hidden on mobile */
            transition: transform 0.3s ease;
            z-index: 100;
        }

        /* Mobile handling for sidebar - hidden by default on small screens if we wanted, 
           but user wants left menu. We'll keep it simple: visible on desktop, hidden on mobile logic handled by JS?
           For now, let's make it responsive. */
        @media(max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* Hidden on mobile initially */

        .sidebar-content {
            overflow-y: auto;
            flex: 1;
            padding: 10px 0;
        }

        .sb-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .sb-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.02);
        }

        .sb-btn.active {
            color: var(--accent);
            background: linear-gradient(90deg, var(--accent-dim), transparent);
            border-left: 3px solid var(--accent);
            padding-left: 17px;
            font-weight: 700;
        }

        .neon-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            margin: 15px 0;
            opacity: 0.5;
        }

        .sb-header {
            padding: 5px 20px;
            font-size: 0.7rem;
            font-weight: 800;
            color: #444;
            letter-spacing: 1px;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        /* MAIN */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* HEADER IMPROVEMENTS */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            height: 60px;
            /* Taller header for mobile touch */
            border-bottom: 1px solid var(--border);
            background: rgba(5, 5, 5, 0.95);
            /* More solid bg */
            position: sticky;
            top: 0;
            z-index: 500;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: none;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 1.4rem;
            color: #fff;
            cursor: pointer;
            padding: 4px 10px;
            display: none;
            /* Desktop hidden */
        }

        .reload-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--accent);
            cursor: pointer;
            padding: 5px;
        }

        /* MOBILE: SPLIT SCREEN (v3.1 - Polished) */
        @media (max-width: 900px) {
            .content-wrapper {
                flex-direction: row !important;
                height: calc(100vh - 60px);
                width: 100vw;
                /* Force full viewport width */
                overflow: hidden;
            }

            .menu-btn {
                display: none !important;
            }

            .reload-btn {
                display: block;
            }

            /* Hide full text logo, show minimal */
            .brand-logo .neon-text {
                display: none;
            }

            .brand-logo::after {
                content: 'RBIT';
                color: #fff;
                font-weight: 800;
                font-size: 1.2rem;
                text-shadow: 0 0 10px var(--accent);
            }

            /* Sidebar Fixed Width */
            .sidebar {
                position: relative;
                width: 110px !important;
                min-width: 110px;
                height: 100%;
                background: #0a0a0a;
                border-right: 1px solid var(--border);
                display: flex !important;
                flex-direction: column;
                padding: 10px 0;
                overflow-y: auto;
                z-index: 10;
                flex-shrink: 0;
            }

            /* Restore Dividers & Headers */
            .sb-header {
                display: block !important;
                font-size: 0.6rem;
                text-align: center;
                margin-top: 10px;
                opacity: 0.7;
            }

            .neon-divider {
                display: block !important;
                margin: 10px auto;
                width: 60%;
            }

            #sbContent {
                display: flex;
                flex-direction: column;
                gap: 5px;
                padding: 0 5px;
            }

            .sb-btn {
                margin: 0 !important;
                width: 100%;
                font-size: 0.7rem;
                padding: 8px 2px;
                text-align: center;
                justify-content: center;
                white-space: normal;
                line-height: 1.1;
                border: 1px solid transparent;
                background: transparent;
            }

            .sb-btn.active {
                background: var(--accent-dim);
                color: var(--accent);
                font-weight: 700;
                border: 1px solid var(--accent);
            }

            /* Content Area Fix - Fill Remaining Space */
            .view-frame {
                padding: 10px;
                overflow-y: auto;
                flex-grow: 1;
                /* Take all space */
                width: auto;
                /* Reset fixed width issues */
                height: 100%;
            }

            /* Ensure Tables use full width */
            /* Force visible bottom nav on mobile */
            .bottom-nav {
                display: none;
            }

            @media (max-width: 900px) {
                .bottom-nav {
                    display: flex;
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 60px;
                    background: #000;
                    border-top: 1px solid var(--border);
                    z-index: 1000;
                    justify-content: space-around;
                    align-items: center;
                }

                .app-container {
                    padding-bottom: 70px;
                    /* Space for bottom nav */
                }

                .sidebar {
                    display: none;
                    /* Hide standard sidebar on mobile */
                }

                /* Mobile Sidebar (when toggled opacity) */
                .sidebar.open {
                    display: flex;
                    position: fixed;
                    top: 0;
                    left: 0;
                    height: 100%;
                    z-index: 2000;
                    width: 80%;
                    background: #000;
                }

                .menu-btn {
                    display: block;
                }
            }

            /* Backdrop */
            .backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1500;
                display: none;
            }

            .backdrop.visible {
                display: block;
            }
    </style>
</head>

<body>

    <div id="backdrop" class="backdrop" onclick="app.toggleSidebar(false)"></div>

    <div class="app-container">

        <!-- SIDEBAR -->
        <aside id="mainSidebar" class="sidebar">
            <div style="padding: 20px 0; text-align:center;">
                <div style="font-weight:900; color:#fff; font-size:1.4rem; letter-spacing:1px;">
                    ARBITRAGE <span style="color:var(--accent)">.IO</span>
                </div>
            </div>

            <div id="sbContent" class="sidebar-content">
                <!-- Injected via JS -->
            </div>

            <div style="margin-top:auto; padding:20px; text-align:center; font-size:0.7rem; color:#444;">
                v3.4.0 Mobile
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <header class="app-header">
                <div style="display:flex; align-items:center;">
                    <button class="menu-btn" onclick="app.toggleSidebar(true)">‚ò∞</button>
                    <div class="brand-logo mobile-only"
                        style="margin-left:10px; font-weight:800; font-size:1.1rem; color:#fff;">
                        RBIT
                    </div>
                </div>

                <div class="header-center">
                    <div id="pageTitle" class="page-title">Loading...</div>
                </div>

                <div class="header-right">
                    <div class="status-bar">
                        <span id="wsStatus" class="status-text">Connecting...</span>
                        <div id="wsDot" class="status-dot"></div>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">

                <!-- VIEW: EXCHANGES (CARDS) -->
                <div id="view-exchanges" class="view-frame active" style="display:block;">
                    <div id="gridTarget" class="opp-grid">
                        <!-- JS RENDERS CARDS HERE -->
                        <div class="empty-state">
                            <div style="font-size:2rem; margin-bottom:10px;">‚ö°</div>
                            <div>Waiting for market data...</div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div id="view-settings" class="view-frame" style="display:none;">
                    <div
                        style="max-width:600px; margin:0 auto; padding:20px; background:#111; border-radius:8px; border:1px solid var(--border);">
                        <h2 style="color:#fff; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
                            Configurations</h2>
                        <div id="settingsForm"></div>
                        <div style="margin-top:20px; text-align:right;">
                            <button onclick="app.saveSettings()"
                                style="background:var(--accent); color:#000; font-weight:bold; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- BOTTOM NAV (Mobile) -->
    <nav class="bottom-nav">
        <button class="bn-item active" onclick="app.nav('funding', this)">
            <span class="bn-icon">‚ö°</span>
            <span>Opps</span>
        </button>
        <button class="bn-item" onclick="app.nav('market', this)">
            <span class="bn-icon">üìä</span>
            <span>Market</span>
        </button>
        <button class="bn-item" onclick="app.nav('settings', this)">
            <span class="bn-icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Scripts start after this point -->
    </style>
    </head>

    <body>
        <!-- The main HTML structure is already defined above line 1000. We just close the body here with script. -->

        <script>
            // --- APP ENGINE ---
            const PAIRS = [
                { id: 'binance-okx', label: 'Binance <> OKX' },
                { id: 'binance-bybit', label: 'Binance <> Bybit' },
                { id: 'binance-hyperliquid', label: 'Binance <> Hyperliquid' },
                { id: 'binance-asterdex', label: 'Binance <> Asterdex' },
                { id: 'okx-bybit', label: 'OKX <> Bybit' },
                { id: 'okx-hyperliquid', label: 'OKX <> Hyperliquid' },
                { id: 'okx-asterdex', label: 'OKX <> Asterdex' },
                { id: 'hyperliquid-asterdex', label: 'HL <> Asterdex' }
            ];

            const EX_COLORS = {
                'BINANCE': '#FCD535',
                'OKX': '#46e8b2',
                'BYBIT': '#FFB119',
                'HYPERLIQUID': '#00D4FF',
                'ASTERDEX': '#888'
            };

            const app = {
                state: {
                    pair: 'binance-okx',
                    view: 'exchanges', // exchanges, list, data
                    module: 'funding',
                    data: {},
                    lastRender: 0,
                    allCoins: []
                },

                init: () => {
                    // Sidebar Injection
                    const sb = document.getElementById('sbContent');
                    if (sb) {
                        // Group pairs logic slightly for better UI if needed, but simple list is fine for now
                        const phtml = PAIRS.map(p => `
                    <button class="sb-btn ${p.id === 'binance-okx' ? 'active' : ''}" data-pair="${p.id}" onclick="app.setPair('${p.id}')">
                        ${p.label}
                    </button>
                `).join('');

                        sb.innerHTML = `
                <div class="sb-header">OPPORTUNITIES</div>
                <button class="sb-btn" onclick="app.setView('all-opps')">‚ö° All Arbitrage Opps</button>
                <div class="neon-divider"></div>
                <div class="sb-header">MARKET PAIRS</div>
                ${phtml}
                <div class="neon-divider"></div>
                <div class="sb-header">DATA</div>
                <button class="sb-btn" onclick="app.setView('all-data')">üìä All Market Data</button>
                `;
                    }

                    // Initial Title
                    app.setPair('binance-okx');
                },

                toggleSidebar: (show) => {
                    const sb = document.getElementById('mainSidebar');
                    const bd = document.getElementById('backdrop');
                    if (show) {
                        sb.classList.add('open');
                        bd.classList.add('visible');
                    } else {
                        sb.classList.remove('open');
                        bd.classList.remove('visible');
                    }
                },

                checkMobileClose: () => {
                    if (window.innerWidth <= 900) app.toggleSidebar(false);
                },

                nav: (target, btn) => {
                    // Mobile Bottom Nav Handler
                    if (btn) {
                        document.querySelectorAll('.bn-item').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    if (target === 'settings') {
                        document.getElementById('view-exchanges').style.display = 'none';
                        document.getElementById('view-settings').style.display = 'block';
                        document.getElementById('pageTitle').innerText = 'Settings';
                    } else if (target === 'funding') {
                        document.getElementById('view-exchanges').style.display = 'block';
                        document.getElementById('view-settings').style.display = 'none';
                        app.setPair(app.state.pair); // Restore title
                    }
                    app.checkMobileClose();
                },

                setPair: (pk) => {
                    app.state.pair = pk;
                    app.state.view = 'exchanges'; // Reset view to cards
                    app.setView('exchanges');

                    // Highlight sidebar
                    document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
                    const btn = document.querySelector(`.sb-btn[data-pair="${pk}"]`);
                    if (btn) btn.classList.add('active');

                    // Colorized Title
                    const p = pk.toUpperCase().split('-');
                    const t = document.getElementById('pageTitle');
                    if (t) {
                        if (p.length > 1) {
                            const c1 = EX_COLORS[p[0]] || '#fff';
                            const c2 = EX_COLORS[p[1]] || '#fff';
                            t.innerHTML = `<span style="color:${c1}; text-shadow:0 0 10px ${c1}44">${p[0]}</span> <span style="color:#555; margin:0 5px;">&lt;&gt;</span> <span style="color:${c2}; text-shadow:0 0 10px ${c2}44">${p[1]}</span>`;
                        } else {
                            t.innerText = pk.replace('-', ' ').toUpperCase();
                            t.style.color = '#fff';
                        }
                    }

                    app.checkMobileClose();
                    if (app.state.data && app.state.data[pk]) app.render(true);
                },

                setView: (v) => {
                    app.state.view = v;
                    // Handle specialized views
                    const grid = document.getElementById('gridTarget');
                    if (v === 'all-opps') {
                        grid.innerHTML = '<div class="empty-state"><div>Calculating all opportunities across all pairs...</div></div>';
                        document.getElementById('pageTitle').innerText = 'All Opportunities';
                    } else if (v === 'all-data') {
                        grid.innerHTML = '<div class="empty-state"><div>Loading market data...</div></div>';
                        document.getElementById('pageTitle').innerText = 'Market Overview';
                    }
                    app.render(true);
                },

                // Helper
                fmtPrice: (p) => {
                    p = parseFloat(p);
                    if (isNaN(p)) return '0.00';
                    if (p > 999) return p.toFixed(2);
                    if (p > 1) return p.toFixed(4);
                    return p.toPrecision(5);
                },
                fmtTime: (ts) => {
                    if (!ts) return '-';
                    const diff = new Date(ts).getTime() - Date.now();
                    if (diff <= 0) return 'Now';
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    return `${h}h ${m}m`;
                },

                render: (force = false) => {
                    const now = Date.now();
                    if (!force && now - app.state.lastRender < 2000) return;
                    app.state.lastRender = now;

                    const grid = document.getElementById('gridTarget');
                    if (!grid) return;

                    let finalHtml = '';

                    // LOGIC FOR DIFFERENT VIEWS
                    if (app.state.view === 'exchanges') {
                        const d = app.state.data[app.state.pair] || [];
                        if (d.length === 0) {
                            // Empty state handled by default HTML or previous render
                            return;
                        }

                        finalHtml = d.map(item => app.renderCard(item)).join('');

                    } else if (app.state.view === 'all-opps') {
                        // Aggregate all pairs
                        let all = [];
                        Object.values(app.state.data).forEach(arr => all.push(...arr));
                        all.sort((a, b) => (b.analysis?.annualAPR || 0) - (a.analysis?.annualAPR || 0));

                        // Render top 50
                        finalHtml = all.slice(0, 50).map(item => app.renderCard(item)).join('');

                    } else if (app.state.view === 'all-data') {
                        // Table view for all data (simplified)
                        finalHtml = `<div style="overflow-x:auto;"><table class="data-list"><thead><tr><th>Coin</th><th>Binance</th><th>OKX</th><th>Bybit</th></tr></thead><tbody>`;
                        finalHtml += app.state.allCoins.map(c => `
                    <tr>
                        <td><b>${c.symbol}</b></td>
                        <td>${c.binance ? c.binance.price : '-'}</td>
                        <td>${c.okx ? c.okx.price : '-'}</td>
                        <td>${c.bybit ? c.bybit.price : '-'}</td>
                    </tr>
                `).join('');
                        finalHtml += `</tbody></table></div>`;
                    }

                    if (finalHtml) grid.innerHTML = finalHtml;
                },

                renderCard: (item) => {
                    const profitClass = item.profit > 0 ? 'profit' : '';
                    const pColor = item.profit > 0 ? 'pos' : (item.profit < 0 ? 'neg' : 'mute');
                    const a = item.analysis || {};

                    return `
                <div class="new-card ${profitClass}">
                    <div class="nc-head">
                        <div class="nc-sym">${item.symbol}</div>
                        <div class="nc-badges">
                             <span class="nc-badge accent">${a.cycleDuration || 8}h Cycle</span>
                             <span class="nc-badge">APR: ${(a.annualAPR || 0).toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="nc-body">
                        <div class="nc-row">
                            <div class="nc-label">Net Profit (Est.)</div>
                            <div class="nc-val-big ${pColor}">${(item.profit || 0).toFixed(4)}%</div>
                        </div>
                        <div class="nc-price-row">
                             <div class="nc-p-box">
                                <span class="nc-p-role" style="color:${EX_COLORS[item.longEx.toUpperCase()] || '#aaa'}">LONG @ ${item.longEx}</span>
                                <span class="nc-p-price">${item.longPrice}</span>
                             </div>
                             <div class="nc-p-box">
                                <span class="nc-p-role" style="color:${EX_COLORS[item.shortEx.toUpperCase()] || '#aaa'}">SHORT @ ${item.shortEx}</span>
                                <span class="nc-p-price">${item.shortPrice}</span>
                             </div>
                         </div>
                         <div class="nc-row">
                            <span class="nc-label">Funding Income</span>
                            <span class="nc-val pos">$${(a.fundingIncomeCycle || 0).toFixed(4)}</span>
                         </div>
                         <div class="nc-row">
                            <span class="nc-label">Next Funding</span>
                            <span class="nc-val">${item.nextFundingTime || '--:--'}</span>
                         </div>
                    </div>
                </div>`;
                }
            };

            // --- WEBSOCKET ---
            let ws;
            let retryCount = 0;

            function connect() {
                const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const url = `${proto}//${window.location.host}`;

                ws = new WebSocket(url);

                ws.onopen = () => {
                    document.getElementById('wsStatus').innerText = 'Connected';
                    document.getElementById('wsStatus').style.color = '#00ff88';
                    document.getElementById('wsDot').classList.add('connected');
                    retryCount = 0;
                };

                ws.onclose = () => {
                    document.getElementById('wsStatus').innerText = 'Reconnecting...';
                    document.getElementById('wsStatus').style.color = '#ffaa00';
                    document.getElementById('wsDot').classList.remove('connected');

                    const timeout = Math.min(1000 * (retryCount + 1), 5000); // Backoff max 5s
                    setTimeout(connect, timeout);
                    retryCount++;
                };

                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'ARBITRAGE_UPDATE') {
                            app.state.data = msg.data;
                            app.state.allCoins = msg.allData || [];

                            // Instant render logic
                            if (retryCount === 0 || document.getElementById('gridTarget').children.length === 0 || document.getElementById('gridTarget').children[0].classList.contains('empty-state')) {
                                app.render(true);
                            } else {
                                app.render();
                            }
                        }
                    } catch (err) { console.error('WS:', err); }
                };
            }

            // INIT
            window.onload = () => {
                app.init();
                connect();
            };
        </script>
    </body>

</html>