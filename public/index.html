<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rbit Terminal</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">


    <style>
        :root {
            --bg: #050505;
            --card-bg: #111;
            --text: #e0e0e0;
            --accent: #F7931A;
            --pos: #00E676;
            --neg: #FF3D00;
            --binance: #FCD535;
            --okx: #fff;
            --bybit: #FFB119;
            --hl: #00D4FF;
            --aster: #888;
            --border: #222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid var(--border);
            background: #080808;
            z-index: 50;
        }

        .logo {
            font-weight: 800;
            font-size: 1.1rem;
            color: #fff;
        }

        .logo span {
            color: var(--accent);
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #fff;
            display: none;
        }

        /* LAYOUT */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: #0a0a0a;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* MOBILE SIDEBAR */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 101;
                transform: translateX(-100%);
                transition: 0.2s;
                padding-top: 50px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .overlay.active {
                display: block;
            }

            .menu-btn {
                display: block;
            }
        }

        /* SIDEBAR ITEMS */
        .sb-sec {
            padding: 15px;
            border-bottom: 1px solid #1a1a1a;
        }

        .sb-head {
            font-size: 0.75rem;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .sb-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            background: transparent;
            border: none;
            color: #bbb;
            font-size: 0.9rem;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        .sb-btn.active {
            background: #1a1a1a;
            color: var(--accent);
            font-weight: 700;
        }

        /* --- ALL DATA TABLE --- */
        .coin-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            display: table;
        }

        .ct-head th {
            text-align: right;
            padding: 10px;
            font-size: 0.8rem;
            border-bottom: 1px solid #333;
        }

        .ct-head th:first-child {
            text-align: left;
        }

        .ct-row td {
            padding: 12px 10px;
            border-bottom: 1px solid #1a1a1a;
            vertical-align: middle;
        }

        .ct-sym {
            font-weight: 700;
            color: #fff;
            font-size: 1rem;
        }

        .ct-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .ct-fund {
            font-family: monospace;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .ct-price {
            font-family: monospace;
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        /* --- ALL OPPS ROW --- */
        .opp-row {
            background: #111;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .or-sym {
            font-weight: 800;
            font-size: 1.1rem;
            color: #fff;
        }

        .or-ex {
            font-size: 0.75rem;
            color: #888;
            display: flex;
            flex-direction: column;
        }

        .or-val {
            font-family: monospace;
            font-size: 0.9rem;
            color: #ddd;
        }

        .or-apr {
            text-align: right;
            font-weight: 800;
            color: var(--accent);
            font-size: 1.1rem;
        }

        /* --- DETAILED CALC CARD --- */
        .calc-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .cc-head {
            background: #161616;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
        }

        .cc-title {
            font-weight: 800;
            font-size: 1.1rem;
            color: #fff;
        }

        .cc-metrics {
            text-align: right;
        }

        .cc-apr {
            color: var(--accent);
            font-weight: 800;
            font-size: 1rem;
        }

        .cc-profit {
            font-family: monospace;
            color: var(--pos);
            font-size: 0.9rem;
        }

        .cc-sides {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid #222;
        }

        .cc-side {
            padding: 10px 15px;
        }

        .cc-side.long {
            border-right: 1px solid #222;
        }

        .cc-lbl {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .cc-ex {
            font-weight: 700;
            font-size: 1rem;
        }

        .cc-long {
            color: var(--pos);
        }

        .cc-short {
            color: var(--neg);
        }

        .cc-steps {
            padding: 15px;
            background: #0c0c0c;
            font-size: 0.85rem;
            color: #999;
        }

        .cc-step {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .cc-step.total {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed #333;
            color: #fff;
            font-weight: 700;
        }

        .cc-val {
            font-family: monospace;
        }

        .pos {
            color: var(--pos);
        }

        .neg {
            color: var(--neg);
        }

        /* NAV */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: #080808;
            border-top: 1px solid #222;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            background: none;
            border: none;
            color: #555;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--accent);
        }
    </style>

</head>

<body>
    <div class="overlay" onclick="ui.toggle(false)"></div>
    <div class="layout" style="height:100vh; padding-top:50px; padding-bottom:60px;">
        <header class="header" style="position:fixed; top:0; width:100%;">
            <div class="logo">R<span>bit</span></div>
            <button class="menu-btn" onclick="ui.toggle(true)">‚ò∞</button>
        </header>

        <aside class="sidebar" id="sidebar">
            <div id="sbContent"></div>
        </aside>

        <main class="main" id="mainView"></main>

        <nav class="nav">
            <button class="nav-item active" onclick="ui.nav('funding')"><span>üìä</span>Funding</button>
            <button class="nav-item" onclick="ui.nav('try')"><span>‚Ç∫</span>TRY Arb</button>
            <button class="nav-item" onclick="ui.nav('usdc')"><span>üí≤</span>USDC</button>
            <button class="nav-item" onclick="ui.nav('settings')"><span>‚öôÔ∏è</span>Settings</button>
        </nav>
    </div>


    <script>
        const PAIR_GROUPS = [
            { t: 'Overview', i: [{ id: 'all-opps', l: 'All Opportunities (Top 100)' }, { id: 'all-coins', l: 'All Data (Table)' }] },
            { t: 'Binance', i: [{ id: 'binance-okx', l: 'Binance <> OKX' }, { id: 'binance-bybit', l: 'Binance <> Bybit' }, { id: 'binance-hyperliquid', l: 'Binance <> HL' }] },
            { t: 'OKX', i: [{ id: 'okx-bybit', l: 'OKX <> Bybit' }, { id: 'okx-hyperliquid', l: 'OKX <> HL' }] },
            { t: 'Bybit', i: [{ id: 'bybit-hyperliquid', l: 'Bybit <> HL' }] }
        ];

        const state = { tab: 'funding', filter: 'all-opps', data: {}, allData: [] };

        const ui = {
            init: () => {
                ui.buildSidebar();
                ui.nav('funding');
                app.connect();
            },

            nav: (t) => {
                state.tab = t;
                document.querySelectorAll('.nav-item').forEach((b, i) => b.classList.toggle('active', ['funding', 'try', 'usdc', 'settings'][i] === t));
                document.querySelector('.menu-btn').style.display = t === 'funding' ? 'block' : 'none';
                ui.render();
            },

            toggle: (s) => {
                const sb = document.getElementById('sidebar');
                const ov = document.querySelector('.overlay');
                if (s) { sb.classList.add('active'); ov.classList.add('active'); }
                else { sb.classList.remove('active'); ov.classList.remove('active'); }
            },

            buildSidebar: () => {
                let h = '';
                PAIR_GROUPS.forEach(g => {
                    h += `<div class="sb-sec"><div class="sb-head">${g.t}</div>`;
                    g.i.forEach(it => {
                        h += `<button class="sb-btn" id="btn-${it.id}" onclick="ui.setFilter('${it.id}')">${it.l}</button>`;
                    });
                    h += `</div>`;
                });
                document.getElementById('sbContent').innerHTML = h;
            },

            setFilter: (f) => {
                state.filter = f;
                ui.toggle(false);
                ui.render();
            },

            render: () => {
                const v = document.getElementById('mainView');
                if (state.tab !== 'funding') {
                    v.innerHTML = `<div style="padding:20px;text-align:center;">Module ${state.tab}</div>`; return;
                }

                document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
                const b = document.getElementById('btn-' + state.filter);
                if (b) b.classList.add('active');

                if (state.filter === 'all-coins') return ui.renderAllCoins(v);
                if (state.filter === 'all-opps') return ui.renderAllOpps(v);
                ui.renderDetailed(v);
            },

            renderAllCoins: (v) => {
                if (!state.allData.length) { v.innerHTML = '<div style="padding:20px;">Loading...</div>'; return; }
                const sorted = [...state.allData].sort((a, b) => a.symbol.localeCompare(b.symbol));
                // Corrected: Backend sends 'markPrice' not 'price'
                const cell = (ex) => {
                    if (!ex) return `<div class="ct-cell"><span class="ct-price">-</span></div>`;
                    const f = parseFloat(ex.fundingRate) * 100; // Corrected: fundingRate
                    return `<div class="ct-cell">
                    <span class="ct-fund ${f > 0 ? 'pos' : 'neg'}">${f.toFixed(4)}%</span>
                    <span class="ct-price">${parseFloat(ex.markPrice).toFixed(4)}</span>
                </div>`;
                };

                let h = `<div style="overflow-x:auto;"><table class="coin-table">
            <thead class="ct-head"><tr>
                <th>COIN</th>
                <th style="color:var(--binance)">BINANCE</th>
                <th style="color:var(--okx)">OKX</th>
                <th style="color:var(--bybit)">BYBIT</th>
                <th style="color:var(--hl)">HYPER</th>
            </tr></thead><tbody>`;
                sorted.forEach(c => {
                    h += `<tr class="ct-row">
                    <td class="ct-sym">${c.symbol}</td>
                    <td>${cell(c.binance)}</td>
                    <td>${cell(c.okx)}</td>
                    <td>${cell(c.bybit)}</td>
                    <td>${cell(c.hyperliquid)}</td>
                </tr>`;
                });
                h += `</tbody></table></div>`;
                v.innerHTML = h;
            },

            renderAllOpps: (v) => {
                let list = [];
                Object.values(state.data).forEach(a => { if (Array.isArray(a)) list.push(...a); });
                if (!list.length) { v.innerHTML = '<div style="padding:20px;">No Opps...</div>'; return; }

                list.sort((a, b) => (b.analysis?.annualAPR || 0) - (a.analysis?.annualAPR || 0));
                list = list.slice(0, 100);

                let h = '<div style="font-size:0.8rem; font-weight:700; color:#666; margin-bottom:10px; padding:0 5px;">TOP 100 APR OPPORTUNITIES</div>';
                list.forEach(d => {
                    const an = d.analysis || {};
                    const apr = an.annualAPR || 0;

                    // Determine Sides based on Strategy
                    let openLong = {}, openShort = {};
                    if (an.strategy === 'LONG_A_SHORT_B') {
                        openLong = d.exchangeA; openShort = d.exchangeB;
                    } else {
                        openLong = d.exchangeB; openShort = d.exchangeA;
                    }

                    h += `<div class="opp-row">
                    <div class="or-sym">${d.symbol}</div>
                    <div class="or-ex">
                        <span style="color:var(--pos)">L: ${openLong.name}</span>
                        <span class="or-val">${parseFloat(openLong.markPrice).toFixed(4)}</span>
                    </div>
                    <div class="or-ex">
                        <span style="color:var(--neg)">S: ${openShort.name}</span>
                        <span class="or-val">${parseFloat(openShort.markPrice).toFixed(4)}</span>
                    </div>
                    <div class="or-apr">${apr.toFixed(0)}%</div>
                </div>`;
                });
                v.innerHTML = h;
            },

            renderDetailed: (v) => {
                // Sort by Net Profit (as requested by User) or APR. User said "Highest APR for top 10".
                // But card should show "first cycle net profit".
                const list = (state.data[state.filter] || []).sort((a, b) => (b.analysis?.annualAPR || 0) - (a.analysis?.annualAPR || 0)).slice(0, 10);
                if (!list.length) { v.innerHTML = `<div style="padding:20px;">No data for ${state.filter}</div>`; return; }

                v.innerHTML = list.map(d => {
                    const an = d.analysis || {};

                    // Identify Sides
                    let openLong = {}, openShort = {};
                    if (an.strategy === 'LONG_A_SHORT_B') {
                        openLong = d.exchangeA; openShort = d.exchangeB;
                    } else {
                        openLong = d.exchangeB; openShort = d.exchangeA;
                    }

                    const apr = an.annualAPR || 0;
                    const netProfit = an.netCycleProfit || 0;
                    // Note: netCycleProfit in backend is an absolute USD value based on tradeSize=100.
                    // To get %, we use tradeSize. tradeSize is 100.
                    const netProfitPercent = netProfit; // Since base is 100, val IS percent.

                    const fees = (an.fees?.open || 0) + (an.fees?.close || 0);
                    const pDiff = an.priceDiffPnL || 0;
                    const fundInc = an.fundingIncomeCycle || 0;

                    return `<div class="calc-card">
                    <div class="cc-head">
                        <div class="cc-title">${d.symbol}</div>
                        <div class="cc-metrics">
                            <div class="cc-apr">${apr.toFixed(1)}% APR</div>
                            <div class="cc-profit">Net: ${netProfitPercent.toFixed(4)}%</div>
                        </div>
                    </div>
                    <div class="cc-sides">
                        <div class="cc-side long">
                            <div class="cc-lbl cc-long">LONG BUY</div>
                            <div class="cc-ex">${openLong.name}</div>
                            <div style="font-family:monospace; color:#888;">$${parseFloat(openLong.markPrice).toFixed(4)}</div>
                        </div>
                        <div class="cc-side">
                            <div class="cc-lbl cc-short">SHORT SELL</div>
                            <div style="font-family:monospace; color:#888;">$${parseFloat(openShort.markPrice).toFixed(4)}</div>
                            <div class="cc-ex">${openShort.name}</div>
                        </div>
                    </div>
                    <div class="cc-steps">
                        <div class="cc-step"><span>Pos Size</span><span class="cc-val">$${(an.tradeSize || 100) * 2}</span></div>
                        <div class="cc-step"><span>Total Fees</span><span class="cc-val neg">-$${fees.toFixed(3)}</span></div>
                        <div class="cc-step"><span>Price Diff Impact</span><span class="cc-val ${pDiff > 0 ? 'pos' : 'neg'}">$${pDiff.toFixed(3)}</span></div>
                        <div class="cc-step"><span>Funding Income</span><span class="cc-val pos">+$${fundInc.toFixed(3)}</span></div>
                        <div class="cc-step total"><span>Est. Net Profit</span><span class="cc-val ${netProfit > 0 ? 'pos' : 'neg'}">$${netProfit.toFixed(4)}</span></div>
                    </div>
                </div>`;
                }).join('');
            }
        };

        const app = {
            connect: () => {
                const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${proto}//${window.location.host}`);
                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'ARBITRAGE_UPDATE') {
                            state.data = msg.data;
                            if (msg.allData) state.allData = msg.allData;
                            if (state.tab === 'funding') ui.render();
                        }
                    } catch (e) { }
                };
                ws.onclose = () => setTimeout(app.connect, 2000);
            }
        };
        window.onload = ui.init;
    </script>
</body>

</html>