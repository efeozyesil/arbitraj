<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Arbitrage Mobile Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --sidebar-bg: #0a0a0a;
            --text-main: #ffffff;
            --text-sub: #888888;
            --accent: #00d4ff;
            --accent-dim: rgba(0, 212, 255, 0.15);
            --positive: #00ff9d;
            --negative: #ff4d4d;
            --border: #222;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }

        /* LAYOUT */
        .app-layout {
            display: flex;
            height: 100%;
            flex-direction: column;
            position: relative;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            padding-bottom: 80px;
        }

        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
            padding: 0 15px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title {
            font-weight: 800;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        .menu-toggle {
            font-size: 1.5rem;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 5px;
        }

        /* SIDEBAR (Drawer) */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 199;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background: var(--sidebar-bg);
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding-top: calc(20px + var(--safe-top));
            padding-bottom: calc(20px + var(--safe-bottom));
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sb-scroll {
            overflow-y: auto;
            flex: 1;
            padding: 0 15px;
        }

        .sb-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sb-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 4px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: #aaa;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: left;
            transition: 0.2s;
        }

        .sb-item:active {
            background: #1a1a1a;
            transform: scale(0.98);
        }

        .sb-item.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: rgba(0, 212, 255, 0.2);
        }

        .neon-sep {
            height: 1px;
            background: linear-gradient(90deg, transparent, #333, transparent);
            margin: 15px 0;
        }

        /* CARDS */
        .opp-card {
            background: var(--card-bg);
            margin: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .opp-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: #444;
        }

        .opp-card.profit::before {
            background: var(--positive);
        }

        .oc-header {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .oc-symbol {
            font-weight: 800;
            font-size: 1.1rem;
            color: #fff;
        }

        .oc-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: #222;
            color: #888;
            border: 1px solid #333;
        }

        .oc-badge.highlight {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }

        .oc-body {
            padding: 15px;
        }

        .oc-main-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
        }

        .oc-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .oc-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: #fff;
            letter-spacing: -1px;
        }

        .oc-value.pos {
            color: var(--positive);
            text-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
        }

        .oc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .oc-box {
            background: #080808;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #1a1a1a;
            text-align: center;
        }

        .oc-role {
            font-size: 0.7rem;
            font-weight: 900;
            display: block;
            margin-bottom: 4px;
        }

        .oc-price {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #ddd;
        }

        /* TRY ARB ORDERBOOK STYLE */
        .try-card {
            background: #111;
            margin: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
        }

        .tc-header {
            padding: 10px 15px;
            background: #161616;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .tc-title {
            font-weight: 700;
            color: #fff;
        }

        .tc-price {
            font-weight: 700;
            font-family: monospace;
            color: var(--accent);
        }

        .ob-container {
            padding: 10px;
            display: flex;
            gap: 5px;
        }

        .ob-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ob-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 4px 6px;
            border-radius: 3px;
        }

        .ob-row.ask {
            background: rgba(255, 77, 77, 0.1);
            color: #ff4d4d;
        }

        .ob-row.bid {
            background: rgba(0, 255, 157, 0.1);
            color: #00ff9d;
        }

        .ob-price {
            font-family: monospace;
            font-weight: 600;
        }

        .ob-amt {
            opacity: 0.7;
        }

        /* SETTINGS */
        .settings-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .save-btn {
            width: 100%;
            background: var(--accent);
            color: #000;
            font-weight: 800;
            padding: 15px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            margin-top: 20px;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(60px + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: #050505;
            border-top: 1px solid #222;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            z-index: 1000;
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: #555;
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 1.4rem;
        }

        .nav-label {
            font-size: 0.65rem;
            font-weight: 600;
        }

        /* UTILS */
        .color-binance {
            color: #FCD535;
        }

        .color-okx {
            color: #46e8b2;
        }

        .color-bybit {
            color: #FFB119;
        }

        .color-hl {
            color: #00D4FF;
        }

        .color-aster {
            color: #999;
        }

        .color-paribu {
            color: #6bf;
        }

        .empty-st {
            text-align: center;
            padding: 50px 20px;
            color: #444;
        }
    </style>
</head>

<body>

    <div class="app-layout">

        <!-- SIDEBAR DRAWER (Only accessible from Funding Tab) -->
        <div class="sidebar-overlay" onclick="app.toggleSidebar(false)"></div>
        <aside class="sidebar" id="appSidebar">
            <div style="padding: 0 15px 20px 15px;">
                <h2 style="color:#fff; font-size:1.5rem;">Filters</h2>
                <div style="font-size:0.8rem; color:#666;">v4.0 Mobile Update</div>
            </div>
            <div class="sb-scroll" id="sbDynamic">
                <!-- JS Will Populate This -->
            </div>
        </aside>

        <!-- HEADER -->
        <header class="header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- Hamburger only shows if on Funding tab -->
                <button class="menu-toggle" id="menuBtn" onclick="app.toggleSidebar(true)">‚ò∞</button>
                <div class="header-title" id="pageTitle">Funding Rates</div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="wsState" style="width: 8px; height: 8px; border-radius: 50%; background: #333;"></div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <div class="main-content" id="mainContent">
            <!-- CONTENT INJECTED HERE -->
        </div>

        <!-- DO NOT REMOVE: BOTTOM NAV -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.nav('funding')">
                <span class="nav-icon">‚ö°</span>
                <span class="nav-label">Funding</span>
            </button>
            <button class="nav-item" onclick="app.nav('try')">
                <span class="nav-icon">‚Ç∫</span>
                <span class="nav-label">TRY Arb</span>
            </button>
            <button class="nav-item" onclick="app.nav('usdc')">
                <span class="nav-icon">üí≤</span>
                <span class="nav-label">USDC Arb</span>
            </button>
            <button class="nav-item" onclick="app.nav('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </button>
        </nav>

    </div>

    <script>
        // --- CONFIG & STATE ---
        const COLORS = {
            'BINANCE': '#FCD535', 'OKX': '#46e8b2', 'BYBIT': '#FFB119',
            'HYPERLIQUID': '#00D4FF', 'ASTERDEX': '#888', 'PARIBU': '#6bf'
        };

        // New Hierarchy Logic
        const PAIR_GROUPS = [
            {
                title: 'Overview', items: [
                    { id: 'all-opps', label: 'All Opportunities' },
                    { id: 'all-coins', label: 'All Coins List' }
                ]
            },
            {
                title: 'Binance Combinations', items: [
                    { id: 'binance-okx', label: 'Binance <> OKX' },
                    { id: 'binance-bybit', label: 'Binance <> Bybit' },
                    { id: 'binance-hyperliquid', label: 'Binance <> Hyperliquid' },
                    { id: 'binance-asterdex', label: 'Binance <> Asterdex' }
                ]
            },
            {
                title: 'OKX Combinations', items: [
                    { id: 'okx-bybit', label: 'OKX <> Bybit' },
                    { id: 'okx-hyperliquid', label: 'OKX <> Hyperliquid' },
                    { id: 'okx-asterdex', label: 'OKX <> Asterdex' }
                ]
            },
            {
                title: 'Bybit Combinations', items: [
                    // Assuming we have these pairs or simulating structure
                    { id: 'bybit-hyperliquid', label: 'Bybit <> Hyperliquid' },
                    { id: 'bybit-asterdex', label: 'Bybit <> Asterdex' }
                ]
            },
            {
                title: 'DeFi Only', items: [
                    { id: 'hyperliquid-asterdex', label: 'Hyperliquid <> Asterdex' }
                ]
            }
        ];

        const app = {
            state: {
                tab: 'funding', // funding, try, usdc, settings
                fundingView: 'all-opps', // Current filter in funding tab
                data: {},
                lastRender: 0,
                wsConnected: false
            },

            init: () => {
                app.renderSidebar();
                app.nav('funding'); // Start at funding
                app.connectWS();
            },

            // --- NAVIGATION ---
            nav: (tab) => {
                app.state.tab = tab;

                // UI Updates
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                // Find button based on onclick text matching is messy, ideally use IDs. 
                // Simple index based:
                const idx = ['funding', 'try', 'usdc', 'settings'].indexOf(tab);
                if (idx > -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');

                // Header & Sidebar Visibility
                const menuBtn = document.getElementById('menuBtn');
                const pageTitle = document.getElementById('pageTitle');

                if (tab === 'funding') {
                    menuBtn.style.visibility = 'visible';
                    pageTitle.innerText = app.getPairLabel(app.state.fundingView);
                } else if (tab === 'try') {
                    menuBtn.style.visibility = 'hidden';
                    pageTitle.innerText = 'TRY Arbitrage';
                } else if (tab === 'usdc') {
                    menuBtn.style.visibility = 'hidden';
                    pageTitle.innerText = 'USDC Arbitrage';
                } else if (tab === 'settings') {
                    menuBtn.style.visibility = 'hidden';
                    pageTitle.innerText = 'Settings';
                }

                app.renderContent();
            },

            // --- SIDEBAR ---
            toggleSidebar: (show) => {
                const el = document.getElementById('appSidebar');
                const ov = document.querySelector('.sidebar-overlay');
                if (show) { el.classList.add('active'); ov.classList.add('active'); }
                else { el.classList.remove('active'); ov.classList.remove('active'); }
            },

            renderSidebar: () => {
                const c = document.getElementById('sbDynamic');
                let html = '';

                PAIR_GROUPS.forEach(g => {
                    html += `<div class="sb-section-title">${g.title}</div>`;
                    g.items.forEach(i => {
                        const active = app.state.fundingView === i.id ? 'active' : '';
                        html += `<button class="sb-item ${active}" onclick="app.setFundingFilter('${i.id}')">${i.label}</button>`;
                    });
                    if (g.title !== 'DeFi Only') html += `<div class="neon-sep"></div>`;
                });

                c.innerHTML = html;
            },

            setFundingFilter: (id) => {
                app.state.fundingView = id;
                app.toggleSidebar(false);
                document.getElementById('pageTitle').innerText = app.getPairLabel(id);
                app.renderSidebar(); // Re-render to update active state
                app.renderContent(true);
            },

            getPairLabel: (id) => {
                for (let g of PAIR_GROUPS) {
                    for (let i of g.items) {
                        if (i.id === id) return i.label;
                    }
                }
                return id;
            },

            // --- CONTENT RENDERING ---
            renderContent: (force = false) => {
                const container = document.getElementById('mainContent');

                // Clean logic based on Tab
                if (app.state.tab === 'funding') {
                    app.renderFunding(container);
                } else if (app.state.tab === 'try') {
                    app.renderTRY(container);
                } else if (app.state.tab === 'usdc') {
                    container.innerHTML = `<div class="empty-st">
                    <div style="font-size:3rem; margin-bottom:10px;">üí≤</div>
                    <div>USDC Peg Monitor<br><small style="color:#666">Module inactive</small></div>
                </div>`;
                } else if (app.state.tab === 'settings') {
                    app.renderSettings(container);
                }
            },

            renderFunding: (container) => {
                const filter = app.state.fundingView;
                let list = [];

                if (filter === 'all-opps') {
                    // Flatten all
                    Object.values(app.state.data).forEach(arr => list.push(...arr));
                    list.sort((a, b) => (b.profit || 0) - (a.profit || 0));
                } else if (filter === 'all-coins') {
                    container.innerHTML = '<div class="empty-st">All Coins List View (Todo)</div>';
                    return;
                } else {
                    list = app.state.data[filter] || [];
                }

                if (list.length === 0) {
                    container.innerHTML = `<div class="empty-st">
                    <div style="margin-bottom:10px;">Waiting for market data...</div>
                    <div style="font-size:0.7rem; color:#555;">Filter: ${app.getPairLabel(filter)}</div>
                </div>`;
                    return;
                }

                container.innerHTML = list.map(item => {
                    const profit = item.profit || 0;
                    const isProfitable = profit > 0;
                    const pClass = isProfitable ? 'profit' : '';
                    const valClass = profit > 0 ? 'pos' : (profit < 0 ? 'neg' : '');

                    return `
                <div class="opp-card ${pClass}">
                    <div class="oc-header">
                        <div class="oc-symbol">${item.symbol}</div>
                        <div class="oc-badge highlight">APR ${(item.analysis?.annualAPR || 0).toFixed(1)}%</div>
                    </div>
                    <div class="oc-body">
                        <div class="oc-main-row">
                            <span class="oc-label">Est. Profit</span>
                            <span class="oc-value ${valClass}">${profit.toFixed(4)}%</span>
                        </div>
                        <div class="oc-grid">
                            <div class="oc-box">
                                <span class="oc-role" style="color:${COLORS[item.longEx.toUpperCase()] || '#aaa'}">LONG ${item.longEx}</span>
                                <span class="oc-price">${item.longPrice}</span>
                            </div>
                            <div class="oc-box">
                                <span class="oc-role" style="color:${COLORS[item.shortEx.toUpperCase()] || '#aaa'}">SHORT ${item.shortEx}</span>
                                <span class="oc-price">${item.shortPrice}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
                }).join('');
            },

            renderTRY: (container) => {
                // MOCK DATA for Try view
                const pairs = [
                    { ex: 'Binance TR', price: 34.12, bid: [34.11, 34.10, 34.09], ask: [34.13, 34.14, 34.15] },
                    { ex: 'Paribu', price: 34.18, bid: [34.15, 34.12, 34.10], ask: [34.20, 34.22, 34.25] },
                    { ex: 'OKX TR', price: 34.11, bid: [34.09, 34.08, 34.05], ask: [34.12, 34.15, 34.18] },
                    { ex: 'Bybit TR', price: 34.13, bid: [34.12, 34.11, 34.10], ask: [34.14, 34.16, 34.17] }
                ];

                let html = `<div style="padding:15px; font-weight:700; color:#888; font-size:0.8rem;">USDT/TRY LIVE RATES (MOCK)</div>`;
                html += pairs.map(p => `
                <div class="try-card">
                    <div class="tc-header">
                        <span class="tc-title" style="color:${COLORS[p.ex.toUpperCase().replace(' TR', '')] || '#fff'}">${p.ex}</span>
                        <span class="tc-price">${p.price.toFixed(2)} ‚Ç∫</span>
                    </div>
                    <div class="ob-container">
                        <div class="ob-side">
                            ${p.bid.map(b => `<div class="ob-row bid"><span class="ob-price">${b.toFixed(2)}</span><span class="ob-amt">BID</span></div>`).join('')}
                        </div>
                        <div class="ob-side">
                            ${p.ask.map(a => `<div class="ob-row ask"><span class="ob-amt">ASK</span><span class="ob-price">${a.toFixed(2)}</span></div>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

                container.innerHTML = html;
            },

            renderSettings: (container) => {
                container.innerHTML = `
            <div class="settings-form">
                <div class="form-group">
                    <label class="form-label">Maker Fee (%)</label>
                    <input type="number" class="form-input" value="0.02">
                </div>
                <div class="form-group">
                    <label class="form-label">Taker Fee (%)</label>
                    <input type="number" class="form-input" value="0.05">
                </div>
                <button class="save-btn" onclick="alert('Settings Saved Locally')">Save Configuration</button>
            </div>`;
            },

            // --- WEBSOCKET ---
            connectWS: () => {
                const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const url = `${proto}//${window.location.host}`;
                const ws = new WebSocket(url);

                ws.onopen = () => {
                    app.state.wsConnected = true;
                    document.getElementById('wsState').style.background = '#00ff9d';
                    document.getElementById('wsState').style.boxShadow = '0 0 10px #00ff9d';
                };

                ws.onclose = () => {
                    app.state.wsConnected = false;
                    document.getElementById('wsState').style.background = '#ff4d4d';
                    document.getElementById('wsState').style.boxShadow = 'none';
                    setTimeout(app.connectWS, 3000);
                };

                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'ARBITRAGE_UPDATE') {
                            app.state.data = msg.data;
                            // Only re-render if we are on funding tab
                            if (app.state.tab === 'funding') app.renderFunding(document.getElementById('mainContent'));
                        }
                    } catch (err) { console.error(err); }
                };
            }
        };

        window.onload = app.init;
    </script>
</body>

</html>