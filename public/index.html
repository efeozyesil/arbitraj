<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Arbitrage Dashboard - Binance vs OKX</title>
    <meta name="description" content="Real-time cryptocurrency arbitrage opportunities">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
            padding-bottom: 80px;
            /* Space for bottom nav */
        }

        /* Header */
        .header {
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(0, 212, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        /* Bottom Navigation - Mobile App Style */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000000;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            font-size: 0.7rem;
            text-align: center;
        }

        .nav-item:hover {
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .nav-item.active {
            color: #00d4ff;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        /* Pair Tabs (Horizontal Scroll) */
        .pair-tabs-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin-bottom: 15px;
            scrollbar-width: thin;
        }

        .pair-tab {
            white-space: nowrap;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pair-tab.active {
            background: rgba(0, 212, 255, 0.15);
            border-color: #00d4ff;
            color: #00d4ff;
            font-weight: 600;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.3rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Opportunities Grid - Prevent Layout Shifts */
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 1.5rem;
            animation: fadeInUp 0.6s ease-out 0.4s both;
            will-change: contents;
        }

        /* Card Styles */
        .scenarios-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }

        .scenario-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scenario-title {
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            letter-spacing: 0.5px;
        }

        .maker-title {
            color: #10b981;
        }

        .taker-title {
            color: #ef4444;
        }

        .scenario-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.72rem;
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .scenario-row .label {
            color: rgba(255, 255, 255, 0.6);
        }

        .scenario-row .value {
            font-weight: 600;
        }

        .scenario-row.net-profit {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-weight: bold;
        }

        .scenario-row.closing {
            opacity: 0.6;
            font-size: 0.68rem;
        }

        .opportunity-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .opportunity-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .opportunity-card.has-opportunity {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.05);
        }

        .coin-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .coin-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
        }

        .coin-name {
            font-size: 1rem;
            font-weight: 700;
        }

        .coin-symbol {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .opportunity-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opportunity-badge.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: glow 2s infinite;
        }

        .opportunity-badge.inactive {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        .exchange-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.6rem;
        }

        .exchange-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.4rem;
        }

        .exchange-logo {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .exchange-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-value {
            font-size: 0.95rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            margin-bottom: 0.3rem;
        }

        .funding-rate {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .funding-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .funding-value {
            font-size: 0.8rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        /* Trading Steps */
        .trading-steps {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.75rem;
            display: none;
            transition: all 0.3s ease;
        }

        .opportunity-card.expanded .trading-steps {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        .steps-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.4rem;
            margin-bottom: 0.3rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border-left: 2px solid rgba(102, 126, 234, 0.5);
        }

        .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-action {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .step-details {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .expand-button {
            width: 100%;
            padding: 0.5rem;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .expand-button:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        /* Tables */
        .opp-table-container {
            width: 100%;
            overflow-x: auto;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .opp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .opp-table th {
            text-align: left;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .opp-table th:hover {
            color: white;
            background: rgba(255, 255, 255, 0.08);
        }

        .opp-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        .opp-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .exchange-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 0.8rem;
        }

        .exchange-badge img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* All Data Table - Fixed Layout to Prevent Shifting */
        #allDataTable {
            overflow-x: auto;
            will-change: scroll-position;
        }

        #allDataTable table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.875rem;
            table-layout: fixed;
            /* Prevent column width changes */
            min-width: 1400px;
        }

        #allDataTable th,
        #allDataTable td {
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px 10px;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #allDataTable th {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            text-align: center;
            font-weight: 600;
            color: #a5b4fc;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        #allDataTable td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: linear-gradient(90deg, #1e1b4b 0%, #1e1b4b 95%, transparent 100%);
            z-index: 5;
            width: 180px;
            /* Fixed width */
            min-width: 180px;
            font-weight: 600;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        #allDataTable .coin-cell {
            display: flex;
            align-items: center;
            gap: 0;
        }

        #allDataTable .coin-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            letter-spacing: 0.5px;
        }

        #allDataTable td {
            font-variant-numeric: tabular-nums;
            transition: background-color 0.15s ease;
            background: rgba(10, 14, 39, 0.6);
            padding: 8px 10px;
            /* More compact */
            font-size: 0.8rem;
        }

        #allDataTable td:hover {
            background: rgba(0, 212, 255, 0.08);
        }

        #allDataTable th {
            padding: 10px !important;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
            }

            50% {
                box-shadow: 0 0 25px rgba(16, 185, 129, 0.8);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media(max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .opportunities-grid {
                grid-template-columns: 1fr;
            }

            .tab-all {
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
            }
        }

        /* Settings Modal & Button */
        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: #1a1b26;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: fadeInDown 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            outline: none;
        }

        .form-select:focus {
            border-color: #667eea;
        }

        .save-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            margin-top: 1rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        .stat-card.compact {
            padding: 0.75rem;
        }

        .stat-card.compact .stat-value {
            font-size: 1.2rem;
        }

        /* Analysis Table & Break Even */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            margin-bottom: 1rem;
        }

        .analysis-table th,
        .analysis-table td {
            padding: 4px 8px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-table th:first-child,
        .analysis-table td:first-child {
            text-align: left;
        }

        .analysis-table th {
            color: rgba(255, 255, 255, 0.5);
            font-weight: normal;
        }

        .break-even-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .break-even-info .highlight {
            font-weight: bold;
            color: #10b981;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>üöÄ Crypto Arbitrage Dashboard</h1>
                <button class="settings-btn" onclick="openSettings()" title="Fee Settings">‚öôÔ∏è</button>
            </div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="wsStatus"></div>
                    <span id="wsStatusText">Connecting...</span>
                </div>
                <div class="status-indicator">
                    <span>Last Update: <span id="lastUpdate">-</span></span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tab-row">
                <button class="tab tab-all active" onclick="switchTab('all')" style="flex:1">ALL OPPORTUNITIES</button>
                <button class="tab tab-all" onclick="switchTab('all-data')" style="flex:1">ALL DATA</button>
            </div>
            <div class="tab-row tab-pairs">
                <button class="tab tab-pair" onclick="switchTab('binance-okx')"><img src="/logos/binance.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/okx.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('binance-hyperliquid')"><img src="/logos/binance.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/hyperliquid.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('binance-bybit')"><img src="/logos/binance.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/bybit.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('binance-asterdex')"><img src="/logos/binance.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/asterdex.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('okx-hyperliquid')"><img src="/logos/okx.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/hyperliquid.png"
                        class="tab-logo"></button>
            </div>
            <div class="tab-row tab-pairs">
                <button class="tab tab-pair" onclick="switchTab('okx-bybit')"><img src="/logos/okx.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/bybit.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('okx-asterdex')"><img src="/logos/okx.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/asterdex.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('hyperliquid-bybit')"><img src="/logos/hyperliquid.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/bybit.png"
                        class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('hyperliquid-asterdex')"><img
                        src="/logos/hyperliquid.png" class="tab-logo"><span class="tab-arrow">‚Üî</span><img
                        src="/logos/asterdex.png" class="tab-logo"></button>
                <button class="tab tab-pair" onclick="switchTab('bybit-asterdex')"><img src="/logos/bybit.png"
                        class="tab-logo"><span class="tab-arrow">‚Üî</span><img src="/logos/asterdex.png"
                        class="tab-logo"></button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Coins</div>
                <div class="stat-value" id="totalOpportunities">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Opportunities</div>
                <div class="stat-value" id="activeArbitrage">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Best 8h Return</div>
                <div class="stat-value" id="bestOpportunity">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Best Annual Return</div>
                <div class="stat-value" id="bestAnnual">-</div>
            </div>
        </div>

        <!-- Coin Counts Grid -->
        <div class="stats-grid" style="margin-top: -1rem; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <div class="stat-card compact">
                <div class="stat-label">Binance Coins</div>
                <div class="stat-value" id="count-Binance">0</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-label">OKX Coins</div>
                <div class="stat-value" id="count-OKX">0</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-label">Hyperliquid Coins</div>
                <div class="stat-value" id="count-Hyperliquid">0</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-label">Bybit Coins</div>
                <div class="stat-value" id="count-Bybit">0</div>
            </div>
            <div class="stat-card compact">
                <div class="stat-label">Asterdex Coins</div>
                <div class="stat-value" id="count-Asterdex">0</div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Loading arbitrage data...</div>
        </div>

        <!-- Pair Tabs -->
        <div id="pairTabs" class="pair-tabs-container" style="display:flex;"></div>

        <!-- Opportunities Grid -->
        <div class="opportunities-grid" id="opportunitiesGrid" style="display:grid;"></div>

        <!-- List Table -->
        <div class="opp-table-container" id="opportunitiesTable" style="display: none;">
            <table class="opp-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('symbol')">Symbol ‚Üï</th>
                        <th onclick="sortTable('long')">Long ‚Üï</th>
                        <th onclick="sortTable('short')">Short ‚Üï</th>
                        <th onclick="sortTable('pricePnL')">Price PnL (100$) ‚Üï</th>
                        <th onclick="sortTable('totalNetProfit')">Net Profit (8h) ‚Üï</th>
                        <th onclick="sortTable('apr')">APR ‚Üï</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <!-- All Data Table -->
        <div class="opportunities-table" id="allDataTable" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">Coin</th>
                        <th colspan="2">Binance</th>
                        <th colspan="2">OKX</th>
                        <th colspan="2">Hyperliquid</th>
                        <th colspan="2">Bybit</th>
                        <th colspan="2">Asterdex</th>
                    </tr>
                    <tr>
                        <th>Price</th>
                        <th>Fund%</th>
                        <th>Price</th>
                        <th>Fund%</th>
                        <th>Price</th>
                        <th>Fund%</th>
                        <th>Price</th>
                        <th>Fund%</th>
                        <th>Price</th>
                        <th>Fund%</th>
                    </tr>
                </thead>
                <tbody id="allDataBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Fee Settings</div>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            <div id="feeSettingsForm"></div>
            <button class="save-btn" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <script>
        let ws;
        let reconnectInterval;
        let currentTab = 'all';
        let allData = {};
        let allCoinsData = [];
        let sortConfig = { key: 'totalNetProfit', direction: 'desc' };

        // Real Fee Settings (Expanded)
        const EXCHANGE_FEES = {
            'Binance': [
                { name: 'Regular (Maker 0.02% / Taker 0.05%)', maker: 0.02, taker: 0.05 },
                { name: 'VIP 1 (Maker 0.016% / Taker 0.04%)', maker: 0.016, taker: 0.04 },
                { name: 'VIP 2 (Maker 0.014% / Taker 0.035%)', maker: 0.014, taker: 0.035 },
                { name: 'VIP 3 (Maker 0.012% / Taker 0.032%)', maker: 0.012, taker: 0.032 },
                { name: 'VIP 4 (Maker 0.01% / Taker 0.03%)', maker: 0.01, taker: 0.03 },
                { name: 'VIP 5 (Maker 0.008% / Taker 0.027%)', maker: 0.008, taker: 0.027 },
                { name: 'VIP 6 (Maker 0.006% / Taker 0.025%)', maker: 0.006, taker: 0.025 },
                { name: 'VIP 7 (Maker 0.004% / Taker 0.022%)', maker: 0.004, taker: 0.022 },
                { name: 'VIP 8 (Maker 0.002% / Taker 0.02%)', maker: 0.002, taker: 0.02 },
                { name: 'VIP 9 (Maker 0% / Taker 0.017%)', maker: 0, taker: 0.017 }
            ],
            'OKX': [
                { name: 'Regular (Maker 0.02% / Taker 0.05%)', maker: 0.02, taker: 0.05 },
                { name: 'VIP 1 (Maker 0.01% / Taker 0.03%)', maker: 0.01, taker: 0.03 },
                { name: 'VIP 2 (Maker 0.008% / Taker 0.028%)', maker: 0.008, taker: 0.028 },
                { name: 'VIP 3 (Maker 0.006% / Taker 0.026%)', maker: 0.006, taker: 0.026 },
                { name: 'VIP 4 (Maker 0.004% / Taker 0.024%)', maker: 0.004, taker: 0.024 },
                { name: 'VIP 5 (Maker 0.002% / Taker 0.022%)', maker: 0.002, taker: 0.022 }
            ],
            'Bybit': [
                { name: 'Non-VIP (Maker 0.02% / Taker 0.055%)', maker: 0.02, taker: 0.055 },
                { name: 'VIP 1 (Maker 0.018% / Taker 0.05%)', maker: 0.018, taker: 0.05 },
                { name: 'VIP 2 (Maker 0.016% / Taker 0.045%)', maker: 0.016, taker: 0.045 },
                { name: 'VIP 3 (Maker 0.014% / Taker 0.04%)', maker: 0.014, taker: 0.04 },
                { name: 'VIP 4 (Maker 0.012% / Taker 0.035%)', maker: 0.012, taker: 0.035 },
                { name: 'Pro 1 (Maker 0.01% / Taker 0.04%)', maker: 0.01, taker: 0.04 },
                { name: 'Pro 2 (Maker 0.008% / Taker 0.035%)', maker: 0.008, taker: 0.035 }
            ],
            'Hyperliquid': [
                { name: 'Regular (Maker 0.01% / Taker 0.035%)', maker: 0.01, taker: 0.035 }
            ],
            'Asterdex': [
                { name: 'Regular (Maker 0.02% / Taker 0.05%)', maker: 0.02, taker: 0.05 }
            ]
        };

        let userFeeSettings = JSON.parse(localStorage.getItem('feeSettings')) || {
            'Binance': 0, 'OKX': 0, 'Hyperliquid': 0, 'Bybit': 0, 'Asterdex': 0
        };

        function getFeeRates(exchangeName) {
            const tiers = EXCHANGE_FEES[exchangeName];
            if (!tiers) return { maker: 0.02, taker: 0.05 };
            const tierIndex = userFeeSettings[exchangeName] || 0;
            return tiers[tierIndex] || tiers[0];
        }

        function calculateAdjustedProfit(opp) {
            const tradeSize = 100;
            const longEx = getLongExchange(opp);
            const shortEx = getShortExchange(opp);

            const longFees = getFeeRates(longEx);
            const shortFees = getFeeRates(shortEx);

            // Entry Fee (Taker assumed)
            const totalEntryFee = tradeSize * (longFees.taker + shortFees.taker) / 100;

            const grossProfit = opp.analysis.totalNetProfit8h || 0;
            return grossProfit - totalEntryFee;
        }

        function openSettings() {
            const form = document.getElementById('feeSettingsForm');
            form.innerHTML = '';
            Object.keys(EXCHANGE_FEES).forEach(exchange => {
                const tiers = EXCHANGE_FEES[exchange];
                const currentTier = userFeeSettings[exchange] || 0;
                const div = document.createElement('div');
                div.className = 'form-group';
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = `${exchange} Fee Tier`;
                const select = document.createElement('select');
                select.className = 'form-select';
                select.id = `fee-${exchange}`;
                tiers.forEach((tier, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = tier.name;
                    if (index === currentTier) option.selected = true;
                    select.appendChild(option);
                });
                div.appendChild(label);
                div.appendChild(select);
                form.appendChild(div);
            });
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }

        function saveSettings() {
            Object.keys(EXCHANGE_FEES).forEach(exchange => {
                const select = document.getElementById(`fee-${exchange}`);
                if (select) userFeeSettings[exchange] = parseInt(select.value);
            });
            localStorage.setItem('feeSettings', JSON.stringify(userFeeSettings));
            closeSettings();
            if (currentTab === 'all') renderAllTable();
            else if (currentTab !== 'all-data') updateDashboard(allData[currentTab]);
        }

        function switchTab(tabId) {
            currentTab = tabId;

            // Update bottom nav active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }

            // Hide all views
            document.getElementById('opportunitiesGrid').style.display = 'none';
            document.getElementById('pairTabs').style.display = 'none'; // Hide tabs on other pages
            document.getElementById('opportunitiesTable').style.display = 'none';
            document.getElementById('allDataTable').style.display = 'none';

            // Show selected view
            if (currentTab === 'all') {
                document.getElementById('opportunitiesTable').style.display = 'block';
                renderAllTable();
            } else if (currentTab === 'all-data') {
                document.getElementById('allDataTable').style.display = 'block';
                renderAllDataTable();
            } else {
                document.getElementById('opportunitiesGrid').style.display = 'grid';
                document.getElementById('pairTabs').style.display = 'flex'; // Show tabs
                if (allData[currentTab]) {
                    updateDashboard(allData[currentTab]);
                }
            }
        }

        function switchToPair(pairKey) {
            currentTab = pairKey;

            // Update nav active state  
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }

            // Show cards
            document.getElementById('opportunitiesGrid').style.display = 'grid';
            document.getElementById('opportunitiesTable').style.display = 'none';
            document.getElementById('allDataTable').style.display = 'none';

            // Load data if available
            if (allData[pairKey]) {
                updateDashboard(allData[pairKey]);
            }
        }

        function getAllOpportunities() {
            let combined = [];
            if (allData && typeof allData === 'object') {
                Object.values(allData).forEach(list => {
                    if (list && Array.isArray(list)) combined.push(...list);
                });
            }
            return combined;
        }

        function renderAllTable() {
            const opportunities = getAllOpportunities();
            const tbody = document.getElementById('tableBody');
            document.getElementById('loading').style.display = 'none';
            if (!opportunities || opportunities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">Waiting for data...</td></tr>';
                return;
            }
            opportunities.sort((a, b) => {
                let valA, valB;
                switch (sortConfig.key) {
                    case 'symbol': valA = a.symbol; valB = b.symbol; break;
                    case 'long': valA = getLongExchange(a); valB = getLongExchange(b); break;
                    case 'short': valA = getShortExchange(a); valB = getShortExchange(b); break;
                    case 'pricePnL': valA = a.analysis.priceDifferencePnL || 0; valB = b.analysis.priceDifferencePnL || 0; break;
                    case 'totalNetProfit': valA = calculateAdjustedProfit(a); valB = calculateAdjustedProfit(b); break;
                    case 'apr': valA = a.analysis.annualAPR || 0; valB = b.analysis.annualAPR || 0; break;
                    default: valA = calculateAdjustedProfit(a); valB = calculateAdjustedProfit(b);
                }
                if (typeof valA === 'string') return sortConfig.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
            });
            tbody.innerHTML = opportunities.map(opp => {
                const longExchange = getLongExchange(opp);
                const shortExchange = getShortExchange(opp);
                const netProfit = calculateAdjustedProfit(opp);

                // Safe null checks
                const priceDiff = opp.analysis && opp.analysis.priceDifferencePnL != null ? opp.analysis.priceDifferencePnL : 0;
                const apr = opp.analysis && opp.analysis.annualAPR != null ? opp.analysis.annualAPR : 0;

                return `
                    <tr onclick="showDetails('${opp.symbol}')">
                        <td style="font-weight:bold; display:flex; align-items:center; gap:8px;"><img src="${opp.logo}" style="width:20px; height:20px; border-radius:50%;" onerror="this.style.display='none'"> ${opp.symbol}</td>
                        <td><span class="exchange-badge"><img src="${getLongExchangeLogo(opp)}" onerror="this.style.display='none'"> ${longExchange}</span></td>
                        <td><span class="exchange-badge"><img src="${getShortExchangeLogo(opp)}" onerror="this.style.display='none'"> ${shortExchange}</span></td>
                        <td class="${priceDiff >= 0 ? 'positive' : 'negative'}">$${priceDiff.toFixed(2)}</td>
                        <td class="${netProfit >= 0 ? 'positive' : 'negative'}" style="font-weight:bold">$${netProfit.toFixed(4)}</td>
                        <td class="${apr > 0 ? 'positive' : 'negative'}">${apr.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
            updateStats(opportunities);
        }

        function createOpportunityCard(opp) {
            const hasOpportunity = opp.analysis.isOpportunity;
            const cardClass = hasOpportunity ? 'opportunity-card has-opportunity' : 'opportunity-card';
            let longExchangeName, shortExchangeName, longExchangeLogo, shortExchangeLogo;
            if (opp.analysis.strategy === 'LONG_A_SHORT_B') {
                longExchangeName = opp.exchangeA.name; shortExchangeName = opp.exchangeB.name;
                longExchangeLogo = opp.exchangeA.logo; shortExchangeLogo = opp.exchangeB.logo;
            } else {
                longExchangeName = opp.exchangeB.name; shortExchangeName = opp.exchangeA.name;
                longExchangeLogo = opp.exchangeB.logo; shortExchangeLogo = opp.exchangeA.logo;
            }

            const tradeSize = 100;
            const longFees = getFeeRates(longExchangeName);
            const shortFees = getFeeRates(shortExchangeName);
            const openLongMaker = (tradeSize * longFees.maker / 100);
            const openLongTaker = (tradeSize * longFees.taker / 100);
            const openShortMaker = (tradeSize * shortFees.maker / 100);
            const openShortTaker = (tradeSize * shortFees.taker / 100);
            const totalEntryTaker = openLongTaker + openShortTaker;
            const totalEntryMaker = openLongMaker + openShortMaker;
            const totalExitTaker = totalEntryTaker;
            const totalExitMaker = totalEntryMaker;
            const priceDiffPnL = opp.analysis.priceDifferencePnL || 0;
            const priceDiffLoss = priceDiffPnL < 0 ? Math.abs(priceDiffPnL) : 0;
            const totalCostTaker = totalEntryTaker + totalExitTaker + priceDiffLoss;
            const totalCostMaker = totalEntryMaker + totalExitMaker + priceDiffLoss;
            const funding8h = opp.analysis.fundingPnL8h || 0;
            const hourlyFunding = funding8h / 8;

            let breakEvenHoursTaker = 'Never';
            let breakEvenHoursMaker = 'Never';
            if (hourlyFunding > 0) {
                breakEvenHoursTaker = (totalCostTaker / hourlyFunding).toFixed(1);
                breakEvenHoursMaker = (totalCostMaker / hourlyFunding).toFixed(1);
            }
            const netProfit = calculateAdjustedProfit(opp);

            // Added data-symbol and specific classes for selective updates
            return `
                <div class="${cardClass}" data-symbol="${opp.symbol}">
                    <div class="coin-header">
                        <div style="display:flex; align-items:center; gap:10px; flex:1;">
                            <div>
                                <div class="coin-name" style="color:#00d4ff; font-weight:800; font-size:1.1rem; text-shadow:0 0 10px rgba(0,212,255,0.5);">${opp.name}</div>
                                <div class="coin-symbol" style="color:rgba(255,255,255,0.6);">${opp.symbol}</div>
                            </div>
                            <div style="margin-left:auto; text-align:right;">
                                <div style="font-size:0.65rem; color:rgba(255,255,255,0.5);">APR</div>
                                <div class="val-apr ${opp.analysis.annualAPR > 0 ? 'positive' : 'negative'}" style="font-size:0.9rem; font-weight:bold;">${opp.analysis.annualAPR.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="opportunity-badge ${hasOpportunity ? 'active' : 'inactive'}">${hasOpportunity ? 'üéØ LIVE' : 'NO SIGNAL'}</div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div class="exchange-box" style="border-left: 2px solid #10b981;">
                            <div class="exchange-header"><span style="font-size:0.7rem; color:#10b981; font-weight:bold;">LONG</span><img src="${longExchangeLogo}" class="exchange-logo" style="margin-left:auto;"><span class="exchange-name">${longExchangeName}</span></div>
                            <div class="price-value val-price-long">$${formatPrice(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeA.markPrice : opp.exchangeB.markPrice)}</div>
                            <div class="funding-rate"><span class="funding-label">Funding</span><span class="funding-value val-funding-long ${parseFloat(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeA.fundingRate : opp.exchangeB.fundingRate) >= 0 ? 'positive' : 'negative'}">${parseFloat(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeA.fundingRate : opp.exchangeB.fundingRate).toFixed(4)}%</span></div>
                            ${opp.analysis.detailedFunding ? `
                                <div style="font-size:0.65rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                                    <div>‚è±Ô∏è Every ${opp.analysis.detailedFunding.exchangeA.fundingInterval}h</div>
                                    <div>‚è∞ Next: ${opp.analysis.detailedFunding.exchangeA.hoursOnly}h ${opp.analysis.detailedFunding.exchangeA.minutesOnly}m</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="exchange-box" style="border-left: 2px solid #ef4444;">
                            <div class="exchange-header"><span style="font-size:0.7rem; color:#ef4444; font-weight:bold;">SHORT</span><img src="${shortExchangeLogo}" class="exchange-logo" style="margin-left:auto;"><span class="exchange-name">${shortExchangeName}</span></div>
                            <div class="price-value val-price-short">$${formatPrice(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeB.markPrice : opp.exchangeA.markPrice)}</div>
                            <div class="funding-rate"><span class="funding-label">Funding</span><span class="funding-value val-funding-short ${parseFloat(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeB.fundingRate : opp.exchangeA.fundingRate) >= 0 ? 'positive' : 'negative'}">${parseFloat(opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeB.fundingRate : opp.exchangeA.fundingRate).toFixed(4)}%</span></div>
                            ${opp.analysis.detailedFunding ? `
                                <div style="font-size:0.65rem; color:rgba(255,255,255,0.5); margin-top:4px;">
                                    <div>‚è±Ô∏è Every ${opp.analysis.detailedFunding.exchangeB.fundingInterval}h</div>
                                    <div>‚è∞ Next: ${opp.analysis.detailedFunding.exchangeB.hoursOnly}h ${opp.analysis.detailedFunding.exchangeB.minutesOnly}m</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="scenarios-grid">
                        <!-- MAKER Scenario (Left) -->
                        <div class="scenario-card">
                            <div class="scenario-title maker-title">MAKER (Limit Orders)</div>
                            <div class="scenario-row">
                                <span class="label">Price Difference</span>
                                <span class="value val-price-diff ${priceDiffPnL >= 0 ? 'positive' : 'negative'}">$${priceDiffPnL.toFixed(2)}</span>
                            </div>
                            <div class="scenario-row">
                                <span class="label">Funding (8h)</span>
                                <span class="value val-funding-8h ${opp.analysis.fundingPnL8h >= 0 ? 'positive' : 'negative'}">$${opp.analysis.fundingPnL8h.toFixed(4)}</span>
                            </div>
                            <div class="scenario-row">
                                <span class="label">Opening Fees</span>
                                <span class="value val-maker-open">-$${totalEntryMaker.toFixed(4)}</span>
                            </div>
                            <div class="scenario-row net-profit">
                                <span class="label">Net Profit</span>
                                <span class="value val-maker-profit ${(priceDiffPnL + opp.analysis.fundingPnL8h - totalEntryMaker) >= 0 ? 'positive' : 'negative'}">$${(priceDiffPnL + opp.analysis.fundingPnL8h - totalEntryMaker).toFixed(4)}</span>
                            </div>
                            <div class="scenario-row closing">
                                <span class="label">Closing Fees (Est.)</span>
                                <span class="value val-maker-close">-$${totalExitMaker.toFixed(4)}</span>
                            </div>
                        </div>

                        <!-- TAKER Scenario (Right) -->
                        <div class="scenario-card">
                            <div class="scenario-title taker-title">TAKER (Market Orders)</div>
                            <div class="scenario-row">
                                <span class="label">Price Difference</span>
                                <span class="value val-price-diff ${priceDiffPnL >= 0 ? 'positive' : 'negative'}">$${priceDiffPnL.toFixed(2)}</span>
                            </div>
                            <div class="scenario-row">
                                <span class="label">Funding (8h)</span>
                                <span class="value val-funding-8h ${opp.analysis.fundingPnL8h >= 0 ? 'positive' : 'negative'}">$${opp.analysis.fundingPnL8h.toFixed(4)}</span>
                            </div>
                            <div class="scenario-row">
                                <span class="label">Opening Fees</span>
                                <span class="value val-taker-open">-$${totalEntryTaker.toFixed(4)}</span>
                            </div>
                            <div class="scenario-row net-profit">
                                <span class="label">Net Profit</span>
                                <span class="value val-taker-profit ${(priceDiffPnL + opp.analysis.fundingPnL8h - totalEntryTaker) >= 0 ? 'positive' : 'negative'}">$${(priceDiffPnL + opp.analysis.fundingPnL8h - totalEntryTaker).toFixed(4)}</span>
                            </div>
                            <div class="scenario-row closing">
                                <span class="label">Closing Fees (Est.)</span>
                                <span class="value val-taker-close">-$${totalExitTaker.toFixed(4)}</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.75rem; text-align:center;">
                        <div style="margin-bottom:4px; color:rgba(255,255,255,0.8);">Recommended Action (100$ Size)</div>
                        <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                            <span style="color:#10b981; font-weight:bold;">LONG $100 ${longExchangeName}</span><span style="opacity:0.5;">+</span><span style="color:#ef4444; font-weight:bold;">SHORT $100 ${shortExchangeName}</span>
                        </div>
                    </div>
                    <button class="expand-button">‚ñº Show Details</button>
                    <div class="trading-steps">
                        <div class="analysis-section">
                            <div class="section-title">üí∞ COST & PROFIT ANALYSIS (100$ Size)</div>
                            <table class="analysis-table">
                                <tr><th>Action</th><th>Maker Fee</th><th>Taker Fee</th></tr>
                                <tr><td>Open LONG (${longExchangeName})</td><td>$${openLongMaker.toFixed(4)}</td><td>$${openLongTaker.toFixed(4)}</td></tr>
                                <tr><td>Open SHORT (${shortExchangeName})</td><td>$${openShortMaker.toFixed(4)}</td><td>$${openShortTaker.toFixed(4)}</td></tr>
                                <tr><td><strong>Total Entry Cost</strong></td><td><strong>$${totalEntryMaker.toFixed(4)}</strong></td><td><strong>$${totalEntryTaker.toFixed(4)}</strong></td></tr>
                                <tr><td>Close Positions (Est.)</td><td>$${totalExitMaker.toFixed(4)}</td><td>$${totalExitTaker.toFixed(4)}</td></tr>
                            </table>
                            ${opp.analysis.detailedFunding ? `
                                <div class="break-even-info">
                                    <div class="section-title" style="font-size:0.85rem; margin:15px 0 10px;">‚è∞ FUNDING TIMELINE</div>
                                    <div style="background:rgba(0,212,255,0.05); padding:10px; border-radius:8px; margin-bottom:10px;">
                                        <div style="font-size:0.75rem; margin-bottom:5px;">üìä First Dual Funding Collection:</div>
                                        <div style="color:#00d4ff; font-weight:bold;">${opp.analysis.detailedFunding.firstDualFundingHours.toFixed(1)} hours</div>
                                        <div style="font-size:0.7rem; color:rgba(255,255,255,0.6); margin-top:3px;">
                                            (When both exchanges have paid funding)
                                        </div>
                                    </div>
                                    <div style="font-size:0.75rem; margin-bottom:8px;">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
                                            <span>Net Funding Rate:</span>
                                            <span class="positive">${opp.analysis.detailedFunding.netFundingRate.toFixed(4)}%</span>
                                        </div>
                                        <div style="display:flex; justify-content:space-between; margin-bottom:3px;">
                                            <span>Fundings/Year:</span>
                                            <span>${opp.analysis.detailedFunding.fundingsPerYear}</span>
                                        </div>
                                    </div>
                                    <div class="section-title" style="font-size:0.85rem; margin:15px 0 10px;">üí∞ BREAK-EVEN ANALYSIS</div>
                                    <div style="font-size:0.75rem;">
                                        <div style="background:rgba(0,255,136,0.05); padding:8px; border-radius:6px; margin-bottom:8px;">
                                            <div style="color:#00ff88; font-weight:bold; margin-bottom:4px;">MAKER (Limit Orders)</div>
                                            <div style="display:flex; justify-content:space-between;">
                                                <span>Initial Fees:</span>
                                                <span class="negative">$${opp.analysis.detailedFunding.fees.totalInitialFeeMaker.toFixed(4)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between;">
                                                <span>Break-Even:</span>
                                                <span class="highlight">${opp.analysis.detailedFunding.breakeven.hoursMaker.toFixed(1)}h (${opp.analysis.detailedFunding.breakeven.daysMaker.toFixed(1)} days)</span>
                                            </div>
                                        </div>
                                        <div style="background:rgba(239,68,68,0.05); padding:8px; border-radius:6px;">
                                            <div style="color:#ef4444; font-weight:bold; margin-bottom:4px;">TAKER (Market Orders)</div>
                                            <div style="display:flex; justify-content:space-between;">
                                                <span>Initial Fees:</span>
                                                <span class="negative">$${opp.analysis.detailedFunding.fees.totalInitialFeeTaker.toFixed(4)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between;">
                                                <span>Break-Even:</span>
                                                <span class="highlight">${opp.analysis.detailedFunding.breakeven.hoursTaker.toFixed(1)}h (${opp.analysis.detailedFunding.breakeven.daysTaker.toFixed(1)} days)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="break-even-info">
                                    <div>Funding Profit (8h): <span class="positive">$${funding8h.toFixed(4)}</span></div>
                                    <div>Break-Even (Maker): <span class="highlight">${breakEvenHoursMaker} hours</span></div>
                                    <div>Break-Even (Taker): <span class="highlight">${breakEvenHoursTaker} hours</span></div>
                                </div>
                            `}
                        </div>
                        <div class="steps-header">EXECUTION STEPS</div>
                        <div class="step-item"><div class="step-number">1</div><div class="step-content"><div class="step-action">Open LONG on ${longExchangeName}</div><div class="step-details">Buy $100 worth of ${opp.symbol} Perpetual (Fee: $${openLongTaker.toFixed(4)})</div></div></div>
                        <div class="step-item"><div class="step-number">2</div><div class="step-content"><div class="step-action">Open SHORT on ${shortExchangeName}</div><div class="step-details">Sell $100 worth of ${opp.symbol} Perpetual (Fee: $${openShortTaker.toFixed(4)})</div></div></div>
                        <div class="step-item"><div class="step-number">3</div><div class="step-content"><div class="step-action">Wait for Funding</div><div class="step-details">Collect funding payments every 8 hours</div></div></div>
                    </div>
                </div>
            `;
        }

        function updateDashboard(opportunities) {
            if (!opportunities) return;
            document.getElementById('loading').style.display = 'none';
            updateStats(opportunities);

            // Sort by APR (highest first)
            opportunities.sort((a, b) => (b.analysis.annualAPR || 0) - (a.analysis.annualAPR || 0));

            // Take only top 10
            const topOpportunities = opportunities.slice(0, 10);

            const grid = document.getElementById('opportunitiesGrid');

            // Remember expanded cards
            const expandedSymbols = new Set();
            grid.querySelectorAll('.opportunity-card.expanded').forEach(card => {
                const symbol = card.getAttribute('data-symbol');
                if (symbol) expandedSymbols.add(symbol);
            });

            // Clear and rebuild
            grid.innerHTML = '';

            topOpportunities.forEach(opp => {
                const cardHTML = createOpportunityCard(opp);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;
                const card = tempDiv.firstElementChild;

                // Restore expanded state
                if (expandedSymbols.has(opp.symbol)) {
                    card.classList.add('expanded');
                    const btn = card.querySelector('.expand-button');
                    if (btn) btn.textContent = '‚ñ≤ Hide Trading Steps';
                }

                grid.appendChild(card);

                // Add event listener
                const btn = card.querySelector('.expand-button');
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        card.classList.toggle('expanded');
                        btn.textContent = card.classList.contains('expanded') ? '‚ñ≤ Hide Trading Steps' : '‚ñº Show Trading Steps';
                    });
                }
            });
        }

        function updateCardValues(card, opp) {
            const hasOpportunity = opp.analysis.isOpportunity;
            const cardClass = hasOpportunity ? 'opportunity-card has-opportunity' : 'opportunity-card';
            // Preserve expanded state
            if (card.classList.contains('expanded')) {
                card.className = cardClass + ' expanded';
            } else {
                card.className = cardClass;
            }

            const badge = card.querySelector('.opportunity-badge');
            if (badge) {
                badge.className = `opportunity-badge ${hasOpportunity ? 'active' : 'inactive'}`;
                badge.textContent = hasOpportunity ? 'üéØ LIVE' : 'NO SIGNAL';
            }

            let longExchange, shortExchange;
            if (opp.analysis.strategy === 'LONG_A_SHORT_B') {
                longExchange = opp.exchangeA; shortExchange = opp.exchangeB;
            } else {
                longExchange = opp.exchangeB; shortExchange = opp.exchangeA;
            }

            // Update Prices and Funding
            const priceLong = card.querySelector('.val-price-long');
            if (priceLong) priceLong.textContent = '$' + formatPrice(longExchange.markPrice);

            const fundingLong = card.querySelector('.val-funding-long');
            if (fundingLong) {
                fundingLong.textContent = parseFloat(longExchange.fundingRate).toFixed(4) + '%';
                fundingLong.className = `funding-value val-funding-long ${longExchange.fundingRate >= 0 ? 'positive' : 'negative'}`;
            }

            const priceShort = card.querySelector('.val-price-short');
            if (priceShort) priceShort.textContent = '$' + formatPrice(shortExchange.markPrice);

            const fundingShort = card.querySelector('.val-funding-short');
            if (fundingShort) {
                fundingShort.textContent = parseFloat(shortExchange.fundingRate).toFixed(4) + '%';
                fundingShort.className = `funding-value val-funding-short ${shortExchange.fundingRate >= 0 ? 'positive' : 'negative'}`;
            }

            // PnL Values
            const priceDiff = card.querySelector('.val-price-diff');
            if (priceDiff) {
                priceDiff.textContent = '$' + opp.analysis.priceDifferencePnL.toFixed(2);
                priceDiff.className = `val-price-diff ${opp.analysis.priceDifferencePnL >= 0 ? 'positive' : 'negative'}`;
            }

            const funding8h = card.querySelector('.val-funding-8h');
            if (funding8h) {
                funding8h.textContent = '$' + opp.analysis.fundingPnL8h.toFixed(4);
                funding8h.className = `val-funding-8h ${opp.analysis.fundingPnL8h >= 0 ? 'positive' : 'negative'}`;
            }

            const netProfit = calculateAdjustedProfit(opp);
            const netProfitEl = card.querySelector('.val-net-profit');
            if (netProfitEl) {
                netProfitEl.textContent = '$' + netProfit.toFixed(4);
                netProfitEl.className = `val-net-profit ${netProfit >= 0 ? 'positive' : 'negative'}`;
            }

            const apr = card.querySelector('.val-apr');
            if (apr) {
                apr.textContent = opp.analysis.annualAPR.toFixed(2) + '%';
                apr.className = `val-apr ${opp.analysis.annualAPR > 0 ? 'positive' : 'negative'}`;
            }

            // Note: We are NOT updating the "Details" section dynamically to save performance and avoid complex DOM manipulation.
            // The details section is mostly static based on initial calculation or requires full re-render.
            // Since details are only visible when expanded, and we want to avoid jitter, we keep them as is until next full refresh or we can implement more granular updates if needed.
            // However, for critical values like Break-Even, we could update them if we added classes to them.
        }

        function formatPrice(price) {
            if (!price) return '-';
            const p = parseFloat(price);
            if (p < 0.001) return p.toFixed(8);
            if (p < 1) return p.toFixed(6);
            if (p < 10) return p.toFixed(4);
            return p.toFixed(2);
        }

        function renderAllDataTable() {
            const tbody = document.getElementById('allDataBody');
            document.getElementById('loading').style.display = 'none';
            allCoinsData.sort((a, b) => a.symbol.localeCompare(b.symbol));

            tbody.innerHTML = allCoinsData.map(coin => {
                const formatCell = (data) => {
                    if (!data) return '<td colspan="2" style="text-align:center; color:rgba(255,255,255,0.2)">-</td>';
                    const fundingClass = data.funding > 0 ? 'positive' : (data.funding < 0 ? 'negative' : '');
                    return `<td style="min-width:90px">$${formatPrice(data.price)}</td><td class="${fundingClass}" style="min-width:70px">${parseFloat(data.funding).toFixed(4)}%</td>`;
                };

                return `<tr>
                    <td>
                        <div class="coin-cell">
                            <span class="coin-name">${coin.symbol}</span>
                        </div>
                    </td>
                    ${formatCell(coin.binance)}
                    ${formatCell(coin.okx)}
                    ${formatCell(coin.hyperliquid)}
                    ${formatCell(coin.bybit)}
                    ${formatCell(coin.asterdex)}
                </tr>`;
            }).join('');

            updateCoinCounts();
        }

        function getLongExchange(opp) { return opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeA.name : opp.exchangeB.name; }
        function getShortExchange(opp) { return opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeB.name : opp.exchangeA.name; }
        function getLongExchangeLogo(opp) { return opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeA.logo : opp.exchangeB.logo; }
        function getShortExchangeLogo(opp) { return opp.analysis.strategy === 'LONG_A_SHORT_B' ? opp.exchangeB.logo : opp.exchangeA.logo; }

        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = (key === 'symbol' || key === 'long' || key === 'short') ? 'asc' : 'desc';
            }
            renderAllTable();
        }

        function updateCoinCounts() {
            if (!allCoinsData || allCoinsData.length === 0) return;
            const counts = { Binance: 0, OKX: 0, Hyperliquid: 0, Bybit: 0, Asterdex: 0 };
            allCoinsData.forEach(coin => {
                if (coin.binance) counts.Binance++;
                if (coin.okx) counts.OKX++;
                if (coin.hyperliquid) counts.Hyperliquid++;
                if (coin.bybit) counts.Bybit++;
                if (coin.asterdex) counts.Asterdex++;
            });
            if (document.getElementById('count-Binance')) document.getElementById('count-Binance').textContent = counts.Binance;
            if (document.getElementById('count-OKX')) document.getElementById('count-OKX').textContent = counts.OKX;
            if (document.getElementById('count-Hyperliquid')) document.getElementById('count-Hyperliquid').textContent = counts.Hyperliquid;
            if (document.getElementById('count-Bybit')) document.getElementById('count-Bybit').textContent = counts.Bybit;
            if (document.getElementById('count-Asterdex')) document.getElementById('count-Asterdex').textContent = counts.Asterdex;
        }

        function updateStats(opportunities) {
            // Get ALL opportunities from allData (not just the filtered parameter)
            const allOpportunities = getAllOpportunities();
            const activeOpps = allOpportunities.filter(o => o.analysis && o.analysis.isOpportunity);

            // Total coins = all coins being tracked
            const totalCoins = allCoinsData.length || 0;
            const totalOppsEl = document.getElementById('totalOpportunities');
            if (totalOppsEl) totalOppsEl.textContent = totalCoins;

            // Active opportunities = coins with actual arbitrage opportunities
            const activeArbEl = document.getElementById('activeArbitrage');
            if (activeArbEl) activeArbEl.textContent = activeOpps.length;

            if (activeOpps.length > 0) {
                const best8h = activeOpps.reduce((max, o) => o.analysis.annualAPR > max.analysis.annualAPR ? o : max);
                const bestOppEl = document.getElementById('bestOpportunity');
                const bestAnnualEl = document.getElementById('bestAnnual');

                if (bestOppEl && best8h.analysis && best8h.analysis.fundingPnL8h != null) {
                    bestOppEl.textContent = best8h.analysis.fundingPnL8h.toFixed(4) + '$';
                }
                if (bestAnnualEl && best8h.analysis && best8h.analysis.annualAPR != null) {
                    bestAnnualEl.textContent = best8h.analysis.annualAPR.toFixed(2) + '%';
                }
            } else {
                const bestOppEl = document.getElementById('bestOpportunity');
                const bestAnnualEl = document.getElementById('bestAnnual');
                if (bestOppEl) bestOppEl.textContent = '0.0000$';
                if (bestAnnualEl) bestAnnualEl.textContent = '0.00%';
            }
            updateCoinCounts();
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                document.getElementById('wsStatus').classList.add('connected');
                document.getElementById('wsStatusText').textContent = 'Connected';
                if (reconnectInterval) { clearInterval(reconnectInterval); reconnectInterval = null; }
            };
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'ARBITRAGE_UPDATE') {
                    allData = message.data;
                    if (message.allData) allCoinsData = message.allData;
                    document.getElementById('lastUpdate').textContent = new Date(message.timestamp).toLocaleTimeString();
                    if (currentTab === 'all') renderAllTable();
                    else if (currentTab === 'all-data') renderAllDataTable();
                    else if (allData[currentTab]) updateDashboard(allData[currentTab]);
                }
            };
            ws.onclose = () => {
                document.getElementById('wsStatus').classList.remove('connected');
                document.getElementById('wsStatusText').textContent = 'Disconnected';
                if (!reconnectInterval) reconnectInterval = setInterval(connectWebSocket, 5000);
            };
        }

        // Initialize
        currentTab = 'binance-okx'; // Default pair
        connectWebSocket();

        // Show default view
        document.getElementById('opportunitiesGrid').style.display = 'grid';
        document.getElementById('pairTabs').style.display = 'flex'; // Show top tabs for pairs

        // Setup initial tabs
        setTimeout(buildPairTabs, 500);

        function buildPairTabs() {
            const tabsContainer = document.getElementById('pairTabs');
            const pairs = Object.keys(allData || {});

            // If data not loaded yet, retry shortly
            if (pairs.length === 0) {
                setTimeout(buildPairTabs, 1000);
                return;
            }

            tabsContainer.innerHTML = pairs.map(pairKey => {
                const isActive = currentTab === pairKey;
                const pairName = pairKey.toUpperCase().replace('-', ' ‚Üî ');
                return `
                    <div class="pair-tab ${isActive ? 'active' : ''}" onclick="switchToPair('${pairKey}')">
                        ${pairName}
                    </div>
                `;
            }).join('');
        }

        function switchToPair(pairKey) {
            currentTab = pairKey;

            // Update Top Tabs Active State
            document.querySelectorAll('.pair-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.innerText.includes(pairKey.toUpperCase().replace('-', ' ‚Üî '))) {
                    tab.classList.add('active');
                }
            });

            // Update Bottom Nav Active State
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item[onclick*="opportunitiesGrid"]').classList.add('active');

            // Show Grid View
            document.getElementById('opportunitiesGrid').style.display = 'grid';
            document.getElementById('pairTabs').style.display = 'flex';
            document.getElementById('opportunitiesTable').style.display = 'none';
            document.getElementById('allDataTable').style.display = 'none';

            if (allData[pairKey]) {
                updateDashboard(allData[pairKey]);
            }
        }
    </script>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchToPair(currentTab || 'binance-okx')">
            <div class="nav-icon">‚ö°</div>
            <div>Exchange</div>
        </button>
        <button class="nav-item" onclick="switchTab('all')">
            <div class="nav-icon">üìä</div>
            <div>All Opps</div>
        </button>
        <button class="nav-item" onclick="switchTab('all-data')">
            <div class="nav-icon">üìà</div>
            <div>All Data</div>
        </button>
    </div>
</body>

</html>