<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rbit | Premium Arbitrage</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800;900&family=JetBrains+Mono:wght@400;500;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-body: #050505;
            --bg-card: #0F0F0F;
            --bg-card-hover: #141414;
            --bg-header: rgba(10, 10, 10, 0.95);
            --bg-sidebar-hint: #0a0a0a;
            --border-color: #222;
            --text-main: #EAEAEA;
            --text-dim: #888;
            --text-accent: #F7931A;
            --pos: #2ebd85;
            --neg: #f6465d;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --binance: #FCD535;
            --okx: #fff;
            --bybit: #FFB119;
            --hl: #2D9CDB;
            --aster: #9B51E0;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100%;
            overflow: hidden;
            /* Disable pull-to-refresh on mobile */
            overscroll-behavior: none;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        /* HERO HEADER */
        .header {
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0;
        }

        /* SIDEBAR HINT - Left edge button that reveals sidebar */
        /* Hidden by default, only visible when body has .funding-tab class */
        .sidebar-hint {
            display: none;
            width: 44px;
            height: 54px;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: none;
            border-right: 1px solid rgba(249, 115, 22, 0.3);
            color: var(--text-accent);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: -16px;
            padding-left: 16px;
        }

        /* Only show when on Funding tab */
        body.funding-tab .sidebar-hint {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-hint:hover {
            color: #fff;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.3) 0%, rgba(249, 115, 22, 0.15) 100%);
        }

        .sidebar-hint:active {
            background: rgba(249, 115, 22, 0.4);
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 900;
            letter-spacing: -0.5px;
            color: #fff;
            margin-left: 12px;
        }

        .logo span {
            color: var(--text-accent);
        }

        /* LAYOUT */
        .layout {
            display: flex;
            flex: 1;
            height: calc(100% - 54px - 60px);
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            background: #080808;
            border-right: 1px solid var(--border-color);
            display: none;
            /* Hidden by default */
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Only show sidebar when on Funding tab */
        body.funding-tab .sidebar {
            display: flex;
        }

        .main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            padding-bottom: 80px;
            width: 100%;
            /* Disable pull-to-refresh in main scroll area */
            overscroll-behavior: contain;
        }

        /* MOBILE */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 101;
        }

        @media (max-width: 768px) {

            /* On mobile, sidebar is hidden off-screen and slides in when .active */
            body.funding-tab .sidebar {
                display: flex;
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 102;
                transform: translateX(-100%);
                transition: transform 0.25s ease;
                border-right: 1px solid #333;
                width: 75%;
                max-width: 280px;
            }

            body.funding-tab .sidebar.active {
                transform: translateX(0);
            }

            .overlay.active {
                display: block;
            }

            .main {
                padding: 12px;
                padding-bottom: 80px;
            }

            .layout {
                height: calc(100% - 54px);
            }

            .logo {
                margin-left: 8px;
            }
        }

        /* SIDEBAR STYLES */
        .sb-sec {
            margin-bottom: 2px;
            border-bottom: 1px solid #141414;
        }

        .sb-head {
            padding: 14px 16px 8px;
            font-size: 0.65rem;
            font-weight: 800;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sb-btn {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 16px;
            color: #999;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.1s;
            border-left: 2px solid transparent;
        }

        .sb-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.02);
        }

        .sb-btn.active {
            background: linear-gradient(90deg, rgba(247, 147, 26, 0.08) 0%, transparent 100%);
            color: var(--text-accent);
            border-left-color: var(--text-accent);
            font-weight: 700;
        }

        /* --- PREMIUM CARD DESIGN (Symmetric Layout) --- */
        .master-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .mc-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(30, 30, 30, 0.4) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .mc-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 2px;
        }

        .mc-sub {
            font-size: 0.75rem;
            color: #888;
            font-family: var(--font-mono);
        }

        .mc-apr {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--text-accent);
            text-align: right;
            text-shadow: 0 0 10px rgba(247, 147, 26, 0.15);
        }

        .mc-apr-lbl {
            font-size: 0.65rem;
            color: #555;
            font-weight: 700;
            text-transform: uppercase;
            text-align: right;
        }

        /* SYMMETRIC SIDES - Labels outside, values center */
        .mc-sides {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid var(--border-color);
        }

        .mc-side {
            padding: 14px;
            display: flex;
            flex-direction: column;
        }

        .mc-side:first-child {
            border-right: 1px solid var(--border-color);
            background: linear-gradient(90deg, rgba(46, 189, 133, 0.08) 0%, transparent 70%);
            align-items: flex-start;
        }

        .mc-side:first-child .mc-grid {
            align-items: stretch;
        }

        /* Values to center */

        .mc-side:last-child {
            background: linear-gradient(-90deg, rgba(246, 70, 93, 0.08) 0%, transparent 70%);
            align-items: flex-end;
            text-align: right;
        }

        .mc-side:last-child .mc-grid {
            align-items: stretch;
        }

        /* Values to center */

        .mc-lbl {
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .long {
            color: var(--pos);
        }

        .short {
            color: var(--neg);
        }

        .mc-ex {
            font-weight: 700;
            font-size: 0.95rem;
            color: #ddd;
            margin-bottom: 2px;
        }

        .mc-price {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: #888;
        }

        .mc-grid {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .mc-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #555;
            width: 100%;
        }

        /* Left side: label at LEFT edge, value at RIGHT (toward center) */
        .mc-side:first-child .mc-row {
            flex-direction: row;
        }

        .mc-side:first-child .mc-row span:first-child {
            text-align: left;
        }

        .mc-side:first-child .mc-row .mc-val {
            text-align: right;
        }

        /* Right side: label at RIGHT edge, value at LEFT (toward center) */
        .mc-side:last-child .mc-row {
            flex-direction: row-reverse;
        }

        .mc-side:last-child .mc-row span:first-child {
            text-align: right;
        }

        .mc-side:last-child .mc-row .mc-val {
            text-align: left;
        }

        .mc-val {
            font-family: var(--font-mono);
            color: #ccc;
            font-weight: 600;
        }

        .pos {
            color: var(--pos);
        }

        .neg {
            color: var(--neg);
        }

        .mc-breakdown {
            padding: 14px;
            background: #080808;
            border-top: 1px solid #1a1a1a;
        }

        .mcb-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .mcb-lbl {
            color: #666;
        }

        .mcb-val {
            font-family: var(--font-mono);
            color: #ccc;
        }

        .mcb-total {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mcb-tot-lbl {
            font-weight: 800;
            font-size: 0.85rem;
            color: #fff;
        }

        .mcb-tot-val {
            font-family: var(--font-mono);
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--pos);
        }

        /* ALL DATA TABLE - Responsive */
        .table-wrap {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ctable {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .ctable th {
            text-align: right;
            padding: 10px 8px;
            background: #111;
            color: #666;
            font-size: 0.65rem;
            font-weight: 800;
            border-bottom: 1px solid #222;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .ctable th:first-child {
            text-align: left;
            padding-left: 12px;
        }

        .ctable td {
            padding: 8px;
            border-bottom: 1px solid #1a1a1a;
            text-align: right;
            vertical-align: middle;
        }

        .ctable td:first-child {
            text-align: left;
            font-weight: 700;
            color: #fff;
            padding-left: 12px;
            font-size: 0.85rem;
        }

        .ct-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1px;
        }

        .ct-f {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.75rem;
        }

        .ct-p {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: #555;
        }

        /* OPP LIST ROW */
        .opp-row {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .opp-sym {
            font-weight: 800;
            font-size: 0.9rem;
            color: #fff;
        }

        .opp-inf {
            display: flex;
            flex-direction: column;
            font-size: 0.7rem;
        }

        .opp-inf span {
            font-family: var(--font-mono);
            color: #888;
        }

        .opp-apr {
            font-weight: 800;
            color: var(--text-accent);
            font-size: 0.95rem;
            text-align: right;
        }

        /* BOTTOM NAV */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: var(--bg-header);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 99;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #555;
            opacity: 0.8;
            transition: 0.2s;
        }

        .nav-item.active {
            color: var(--text-accent);
            opacity: 1;
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        /* TRY CARD */
        .try-card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .tc-h {
            padding: 10px 14px;
            background: #161616;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #222;
        }

        .tc-t {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .tc-p {
            font-family: var(--font-mono);
            color: var(--text-accent);
            font-weight: 700;
        }

        .tc-d {
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .tr {
            display: flex;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 2px;
            margin-bottom: 2px;
        }

        .tb {
            background: rgba(46, 189, 133, 0.1);
            color: var(--pos);
        }

        .ta {
            background: rgba(246, 70, 93, 0.1);
            color: var(--neg);
        }

        /* USDC CARD */
        .usdc-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .usdc-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .usdc-pair {
            font-weight: 800;
            font-size: 1rem;
        }

        .usdc-spread {
            font-family: var(--font-mono);
            color: var(--pos);
            font-weight: 700;
        }

        .usdc-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .usdc-lbl {
            color: #666;
        }

        .usdc-val {
            font-family: var(--font-mono);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-left">
            <button class="sidebar-hint" id="sidebarHint" onclick="ui.toggle(true)">‚ò∞</button>
            <div class="logo">R<span>bit</span></div>
        </div>
    </div>

    <div class="overlay" onclick="ui.toggle(false)"></div>
    <div class="layout">
        <aside class="sidebar" id="sidebar">
            <div id="sbContent"></div>
        </aside>
        <main class="main" id="mainView"></main>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="ui.nav('funding')"><span class="nav-icon">üìä</span>Funding</button>
        <button class="nav-item" onclick="ui.nav('try')"><span class="nav-icon">‚Ç∫</span>TRY Arb</button>
        <button class="nav-item" onclick="ui.nav('usdc')"><span class="nav-icon">üí≤</span>USDC</button>
        <button class="nav-item" onclick="ui.nav('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
    </nav>

    <script>
        const PAIR_GROUPS = [
            { t: 'Overview', i: [{ id: 'all-opps', l: 'All Opportunities' }, { id: 'all-coins', l: 'All Data (Table)' }] },
            { t: 'Binance Pairs', i: [{ id: 'binance-okx', l: 'Binance <> OKX' }, { id: 'binance-bybit', l: 'Binance <> Bybit' }, { id: 'binance-hyperliquid', l: 'Binance <> HL' }, { id: 'binance-asterdex', l: 'Binance <> Aster' }] },
            { t: 'OKX Pairs', i: [{ id: 'okx-bybit', l: 'OKX <> Bybit' }, { id: 'okx-hyperliquid', l: 'OKX <> HL' }, { id: 'okx-asterdex', l: 'OKX <> Aster' }] },
            { t: 'Bybit Pairs', i: [{ id: 'bybit-hyperliquid', l: 'Bybit <> HL' }, { id: 'bybit-asterdex', l: 'Bybit <> Aster' }] },
            { t: 'Hyperliquid Pairs', i: [{ id: 'hyperliquid-asterdex', l: 'HL <> Aster' }] }
        ];

        const state = { tab: 'funding', filter: 'all-opps', data: {}, allData: [], tryData: [], usdcData: [] };

        const ui = {
            init: () => {
                ui.buildSidebar();
                ui.nav('funding');
                app.connect();
                setInterval(ui.updateLiveData, 2000);
            },

            nav: (t) => {
                state.tab = t;
                // Toggle body class for sidebar hint visibility (CSS controls this)
                if (t === 'funding') {
                    document.body.classList.add('funding-tab');
                } else {
                    document.body.classList.remove('funding-tab');
                    ui.toggle(false); // Close sidebar when leaving funding tab
                }

                document.querySelectorAll('.nav-item').forEach((b, i) => b.classList.toggle('active', ['funding', 'try', 'usdc', 'settings'][i] === t));
                ui.render();
            },

            toggle: (s) => {
                const sb = document.getElementById('sidebar');
                const ov = document.querySelector('.overlay');
                if (s) { sb.classList.add('active'); ov.classList.add('active'); }
                else { sb.classList.remove('active'); ov.classList.remove('active'); }
            },

            buildSidebar: () => {
                let h = '';
                PAIR_GROUPS.forEach(g => {
                    h += `<div class="sb-sec"><div class="sb-head">${g.t}</div>`;
                    g.i.forEach(it => {
                        h += `<button class="sb-btn" id="btn-${it.id}" onclick="ui.setFilter('${it.id}')">${it.l}</button>`;
                    });
                    h += `</div>`;
                });
                document.getElementById('sbContent').innerHTML = h;
            },

            setFilter: (f) => {
                state.filter = f;
                ui.toggle(false);
                ui.render();
            },

            render: () => {
                const v = document.getElementById('mainView');
                if (state.tab === 'try') return ui.renderTRY(v);
                if (state.tab === 'usdc') return ui.renderUSDC(v);
                if (state.tab === 'settings') return ui.renderSettings(v);
                if (state.tab !== 'funding') { v.innerHTML = `<div style="padding:40px;text-align:center;color:#444;">Module ${state.tab}</div>`; return; }

                document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
                const b = document.getElementById('btn-' + state.filter);
                if (b) b.classList.add('active');

                if (state.filter === 'all-coins') return ui.renderAllCoins(v);
                if (state.filter === 'all-opps') return ui.renderAllOpps(v);
                ui.renderDetailed(v);
            },

            formatTime: (ms) => {
                if (!ms) return '8h 00m';
                const diff = ms - Date.now();
                if (diff <= 0) return 'Now';
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                return `${h}h ${m}m`;
            },

            renderAllCoins: (v) => {
                if (!state.allData.length) { v.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">Loading Data...</div>'; return; }
                const sorted = [...state.allData].sort((a, b) => a.symbol.localeCompare(b.symbol));

                const cell = (ex) => {
                    if (!ex || !ex.price) return `<td><span style="color:#333;">-</span></td>`;
                    const f = Number(ex.funding || 0);
                    const fs = isNaN(f) ? '0.00%' : f.toFixed(4) + '%';
                    // Color based on funding rate
                    const cls = f > 0 ? 'pos' : (f < 0 ? 'neg' : '');

                    return `<td><div class="ct-cell">
                    <span class="ct-f ${cls}">${fs}</span>
                    <span class="ct-p">${Number(ex.price).toFixed(2)}</span>
                </div></td>`;
                };

                let h = `<div class="table-wrap"><table class="ctable">
            <thead><tr>
                <th>Coin</th>
                <th style="color:var(--binance)">Binance</th>
                <th style="color:var(--okx)">OKX</th>
                <th style="color:var(--bybit)">Bybit</th>
                <th style="color:var(--hl)">HL</th>
                <th style="color:var(--aster)">Aster</th>
            </tr></thead><tbody>`;
                sorted.forEach(c => {
                    h += `<tr>
                    <td>${c.symbol}</td>
                    ${cell(c.binance)}
                    ${cell(c.okx)}
                    ${cell(c.bybit)}
                    ${cell(c.hyperliquid)}
                    ${cell(c.asterdex)}
                </tr>`;
                });
                h += `</tbody></table></div>`;
                v.innerHTML = h;
            },

            renderAllOpps: (v) => {
                let list = [];
                Object.values(state.data).forEach(a => { if (Array.isArray(a)) list.push(...a); });
                if (!list.length) { v.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">Scanning...</div>'; return; }

                const tradeSize = 100;
                const now = Date.now();

                // Calculate next funding profit for each opportunity
                list = list.map(d => {
                    const an = d.analysis || {};
                    const det = an.detailed || {};
                    const intervals = det.intervals || { a: 8, b: 8 };
                    const isA_Long = an.strategy === 'LONG_A_SHORT_B';
                    const L = isA_Long ? d.exchangeA : d.exchangeB;
                    const S = isA_Long ? d.exchangeB : d.exchangeA;
                    const lf = Number(L.fundingRate || 0);
                    const sf = Number(S.fundingRate || 0);
                    const longInterval = isA_Long ? intervals.a : intervals.b;
                    const shortInterval = isA_Long ? intervals.b : intervals.a;
                    const longNextTime = L.nextFundingTime || 0;
                    const shortNextTime = S.nextFundingTime || 0;

                    // Calculate next common funding point
                    const nextCommon = Math.max(longNextTime, shortNextTime);

                    // Count payments until next common
                    let longPayments = 0, shortPayments = 0;
                    if (longNextTime > 0 && longInterval > 0) {
                        let t = longNextTime;
                        while (t <= nextCommon) { longPayments++; t += longInterval * 3600000; }
                    }
                    if (shortNextTime > 0 && shortInterval > 0) {
                        let t = shortNextTime;
                        while (t <= nextCommon) { shortPayments++; t += shortInterval * 3600000; }
                    }

                    const nextLongPnL = tradeSize * (lf / 100) * longPayments * -1;
                    const nextShortPnL = tradeSize * (sf / 100) * shortPayments * 1;
                    const nextFundingProfit = nextLongPnL + nextShortPnL;

                    return { ...d, nextFundingProfit, nextCommon };
                });

                // Filter only profitable in first cycle
                list = list.filter(d => d.nextFundingProfit > 0);

                // Sort by next funding profit (highest first)
                list.sort((a, b) => b.nextFundingProfit - a.nextFundingProfit);
                list = list.slice(0, 50);

                if (!list.length) {
                    v.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">No profitable opportunities in next funding cycle</div>';
                    return;
                }

                let h = '<div style="font-size:0.7rem; font-weight:800; color:#444; margin-bottom:10px; padding-left:4px; text-transform:uppercase;">Profitable in Next Cycle</div>';
                list.forEach(d => {
                    const an = d.analysis || {};
                    const isA_Long = an.strategy === 'LONG_A_SHORT_B';
                    const L = isA_Long ? d.exchangeA : d.exchangeB;
                    const S = isA_Long ? d.exchangeB : d.exchangeA;
                    const lf = Number(L.fundingRate || 0), sf = Number(S.fundingRate || 0);
                    const profit = d.nextFundingProfit || 0;

                    h += `<div class="opp-row">
                    <div class="opp-sym">${d.symbol}</div>
                    <div class="opp-inf">
                        <span style="color:var(--pos); font-weight:700;">L: ${L.name}</span>
                        <span>${Number(L.markPrice).toFixed(4)}</span>
                        <span class="${lf > 0 ? 'pos' : 'neg'}">${lf.toFixed(4)}%</span>
                    </div>
                    <div class="opp-inf">
                        <span style="color:var(--neg); font-weight:700;">S: ${S.name}</span>
                        <span>${Number(S.markPrice).toFixed(4)}</span>
                        <span class="${sf > 0 ? 'pos' : 'neg'}">${sf.toFixed(4)}%</span>
                    </div>
                    <div class="opp-apr pos">+$${profit.toFixed(2)}</div>
                </div>`;
                });
                v.innerHTML = h;
            },

            renderDetailed: (v) => {
                let list = state.data[state.filter] || [];
                if (!list.length) { v.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.5;">Waiting for data...</div>`; return; }

                const tradeSize = 100;
                const now = Date.now();

                // Calculate next funding profit and filter profitable ones
                list = list.map(d => {
                    const an = d.analysis || {};
                    const det = an.detailed || {};
                    const intervals = det.intervals || { a: 8, b: 8 };
                    const isA_Long = an.strategy === 'LONG_A_SHORT_B';
                    const L = isA_Long ? d.exchangeA : d.exchangeB;
                    const S = isA_Long ? d.exchangeB : d.exchangeA;
                    const lf = Number(L.fundingRate || 0);
                    const sf = Number(S.fundingRate || 0);
                    const longInterval = isA_Long ? intervals.a : intervals.b;
                    const shortInterval = isA_Long ? intervals.b : intervals.a;
                    const longNextTime = L.nextFundingTime || 0;
                    const shortNextTime = S.nextFundingTime || 0;

                    const nextCommon = Math.max(longNextTime, shortNextTime);
                    let longPayments = 0, shortPayments = 0;
                    if (longNextTime > 0 && longInterval > 0) {
                        let t = longNextTime;
                        while (t <= nextCommon) { longPayments++; t += longInterval * 3600000; }
                    }
                    if (shortNextTime > 0 && shortInterval > 0) {
                        let t = shortNextTime;
                        while (t <= nextCommon) { shortPayments++; t += shortInterval * 3600000; }
                    }

                    const nextLongPnL = tradeSize * (lf / 100) * longPayments * -1;
                    const nextShortPnL = tradeSize * (sf / 100) * shortPayments * 1;
                    const nextFundingProfit = nextLongPnL + nextShortPnL;

                    return { ...d, nextFundingProfit };
                }).filter(d => d.nextFundingProfit > 0);

                // Sort by next funding profit
                list.sort((a, b) => b.nextFundingProfit - a.nextFundingProfit);
                list = list.slice(0, 10);

                if (!list.length) {
                    v.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.5;">No profitable opportunities in next cycle for this pair</div>`;
                    return;
                }

                // Load saved settings for fee calculations
                const savedSettings = ui.loadSettings();
                const savedFees = savedSettings?.fees || {};
                const savedTradeSize = savedSettings?.tradeSize || 100;

                v.innerHTML = list.map(d => {
                    const an = d.analysis || {};
                    const isA_Long = an.strategy === 'LONG_A_SHORT_B';
                    const L = isA_Long ? d.exchangeA : d.exchangeB;
                    const S = isA_Long ? d.exchangeB : d.exchangeA;

                    const lf = Number(L.fundingRate || 0);
                    const sf = Number(S.fundingRate || 0);

                    // Get detailed cycle info from backend
                    const det = an.detailed || {};
                    const cycle = det.cycle || {};
                    const intervals = det.intervals || { a: 8, b: 8 };

                    // Use saved trade size
                    const tradeSize = savedTradeSize;

                    // Get exchange-specific fees from settings
                    const longExKey = L.name.toLowerCase();
                    const shortExKey = S.name.toLowerCase();
                    const longFees = savedFees[longExKey] || { maker: 0.02, taker: 0.05 };
                    const shortFees = savedFees[shortExKey] || { maker: 0.02, taker: 0.05 };

                    // Calculate fees: Open Long + Close Long + Open Short + Close Short
                    const makerFeeTotal = tradeSize * ((longFees.maker + shortFees.maker) / 100) * 2;
                    const takerFeeTotal = tradeSize * ((longFees.taker + shortFees.taker) / 100) * 2;

                    const priceDiff = an.priceDiffPnL || 0;

                    // Map Long/Short to A/B correctly
                    const longExName = L.name;
                    const shortExName = S.name;
                    const longInterval = isA_Long ? intervals.a : intervals.b;
                    const shortInterval = isA_Long ? intervals.b : intervals.a;
                    const longNextTime = L.nextFundingTime || 0;
                    const shortNextTime = S.nextFundingTime || 0;

                    // Calculate hours remaining until next funding
                    const now = Date.now();
                    const longHoursRemaining = Math.max(0, (longNextTime - now) / 3600000);
                    const shortHoursRemaining = Math.max(0, (shortNextTime - now) / 3600000);

                    // === DYNAMIC NEXT FUNDING PROFIT ===
                    // Calculate how many payments happen until the NEXT common funding point
                    // Common endpoint = max of the two next times (when both have funded at least once)
                    const nextCommon = Math.max(longNextTime, shortNextTime);
                    const hoursUntilCommon = Math.max(0, (nextCommon - now) / 3600000);

                    // Long exchange: how many times will it pay until nextCommon?
                    let longNextPayments = 0;
                    if (longNextTime > 0 && longInterval > 0) {
                        let t = longNextTime;
                        while (t <= nextCommon) {
                            longNextPayments++;
                            t += longInterval * 3600000;
                        }
                    }

                    // Short exchange: how many times will it pay until nextCommon?
                    let shortNextPayments = 0;
                    if (shortNextTime > 0 && shortInterval > 0) {
                        let t = shortNextTime;
                        while (t <= nextCommon) {
                            shortNextPayments++;
                            t += shortInterval * 3600000;
                        }
                    }

                    const nextLongPnL = tradeSize * (lf / 100) * longNextPayments * -1;
                    const nextShortPnL = tradeSize * (sf / 100) * shortNextPayments * 1;
                    const nextFundingTotal = nextLongPnL + nextShortPnL;

                    // === STANDARD 8H CYCLE ===
                    const std8hLongPayments = Math.floor(8 / longInterval);
                    const std8hShortPayments = Math.floor(8 / shortInterval);
                    const std8hLongPnL = tradeSize * (lf / 100) * std8hLongPayments * -1;
                    const std8hShortPnL = tradeSize * (sf / 100) * std8hShortPayments * 1;
                    const std8hFundingTotal = std8hLongPnL + std8hShortPnL;

                    // Profit calculations
                    const makerProfit = std8hFundingTotal + priceDiff - makerFeeTotal;
                    const takerProfit = std8hFundingTotal + priceDiff - takerFeeTotal;

                    // Format time remaining helper
                    const fmtRemaining = (ms) => {
                        if (!ms || ms <= 0) return '-';
                        const h = Math.floor(ms / 3600000);
                        const m = Math.floor((ms % 3600000) / 60000);
                        return `${h}h ${m}m`;
                    };

                    return `<div class="master-card">
                    <div class="mc-header">
                        <div>
                            <div class="mc-title">${d.symbol}</div>
                            <div class="mc-sub">Standard Cycle: 8h</div>
                        </div>
                        <div>
                            <div class="mc-apr">${(an.annualAPR || 0).toFixed(0)}%</div>
                            <div class="mc-apr-lbl">Annual APR</div>
                        </div>
                    </div>

                    <div class="mc-sides">
                        <div class="mc-side">
                            <span class="mc-lbl long">Long Buy</span>
                            <div class="mc-ex">${L.name}</div>
                            <div class="mc-price">$${Number(L.markPrice).toFixed(4)}</div>
                            <div class="mc-grid">
                                <div class="mc-row"><span>Funding</span><span class="mc-val ${lf > 0 ? 'pos' : 'neg'}">${lf.toFixed(4)}%</span></div>
                                <div class="mc-row"><span>Next In</span><span class="mc-val">${fmtRemaining(longNextTime - now)}</span></div>
                                <div class="mc-row"><span>Interval</span><span class="mc-val">${longInterval}h</span></div>
                            </div>
                        </div>
                        <div class="mc-side">
                            <span class="mc-lbl short">Short Sell</span>
                            <div class="mc-ex">${S.name}</div>
                            <div class="mc-price">$${Number(S.markPrice).toFixed(4)}</div>
                            <div class="mc-grid">
                                <div class="mc-row"><span>Funding</span><span class="mc-val ${sf > 0 ? 'pos' : 'neg'}">${sf.toFixed(4)}%</span></div>
                                <div class="mc-row"><span>Next In</span><span class="mc-val">${fmtRemaining(shortNextTime - now)}</span></div>
                                <div class="mc-row"><span>Interval</span><span class="mc-val">${shortInterval}h</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Funding Breakdown: Next vs Standard 8h -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                        <!-- Next Funding Profit (Dynamic) -->
                        <div style="padding:10px; background:rgba(139,92,246,0.03); border-radius:8px; border:1px solid rgba(139,92,246,0.08);">
                            <div style="font-size:0.6rem; font-weight:700; color:rgba(139,92,246,0.8); margin-bottom:6px; text-transform:uppercase;">
                                Next Funding <span style="font-weight:400;">(${fmtRemaining(hoursUntilCommon * 3600000)})</span>
                            </div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.55rem;">L: ${longExName} √ó${longNextPayments}</span><span class="mcb-val ${nextLongPnL >= 0 ? 'pos' : 'neg'}" style="font-size:0.65rem;">${nextLongPnL >= 0 ? '+' : ''}$${nextLongPnL.toFixed(2)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.55rem;">S: ${shortExName} √ó${shortNextPayments}</span><span class="mcb-val ${nextShortPnL >= 0 ? 'pos' : 'neg'}" style="font-size:0.65rem;">${nextShortPnL >= 0 ? '+' : ''}$${nextShortPnL.toFixed(2)}</span></div>
                            <div style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(139,92,246,0.1);"><div style="display:flex; justify-content:space-between;"><span style="font-size:0.6rem; color:#888;">Total</span><span style="font-size:0.75rem; font-weight:700;" class="${nextFundingTotal >= 0 ? 'pos' : 'neg'}">${nextFundingTotal >= 0 ? '+' : ''}$${nextFundingTotal.toFixed(2)}</span></div></div>
                        </div>

                        <!-- Standard 8h Cycle -->
                        <div style="padding:10px; background:rgba(100,116,139,0.03); border-radius:8px; border:1px solid rgba(100,116,139,0.08);">
                            <div style="font-size:0.6rem; font-weight:700; color:rgba(100,116,139,0.8); margin-bottom:6px; text-transform:uppercase;">
                                Standard 8h Cycle
                            </div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.55rem;">L: ${longExName} √ó${std8hLongPayments}</span><span class="mcb-val ${std8hLongPnL >= 0 ? 'pos' : 'neg'}" style="font-size:0.65rem;">${std8hLongPnL >= 0 ? '+' : ''}$${std8hLongPnL.toFixed(2)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.55rem;">S: ${shortExName} √ó${std8hShortPayments}</span><span class="mcb-val ${std8hShortPnL >= 0 ? 'pos' : 'neg'}" style="font-size:0.65rem;">${std8hShortPnL >= 0 ? '+' : ''}$${std8hShortPnL.toFixed(2)}</span></div>
                            <div style="margin-top:4px; padding-top:4px; border-top:1px solid rgba(100,116,139,0.1);"><div style="display:flex; justify-content:space-between;"><span style="font-size:0.6rem; color:#888;">Total</span><span style="font-size:0.75rem; font-weight:700;" class="${std8hFundingTotal >= 0 ? 'pos' : 'neg'}">${std8hFundingTotal >= 0 ? '+' : ''}$${std8hFundingTotal.toFixed(2)}</span></div></div>
                        </div>
                    </div>

                    <!-- Maker vs Taker Comparison (Blue / Orange) -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <!-- Maker Column (Blue) -->
                        <div style="padding:10px; background:rgba(59,130,246,0.03); border-radius:8px; border:1px solid rgba(59,130,246,0.08);">
                            <div style="font-size:0.65rem; font-weight:700; color:rgba(59,130,246,0.8); margin-bottom:8px;">MAKER (Limit)</div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Fees (${longFees.maker}%+${shortFees.maker}%)√ó2</span><span class="mcb-val neg" style="font-size:0.7rem;">-$${makerFeeTotal.toFixed(3)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Price Diff</span><span class="mcb-val ${priceDiff > 0 ? 'pos' : 'neg'}" style="font-size:0.7rem;">${priceDiff >= 0 ? '+' : ''}$${priceDiff.toFixed(3)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Funding (8h)</span><span class="mcb-val ${std8hFundingTotal >= 0 ? 'pos' : 'neg'}" style="font-size:0.7rem;">${std8hFundingTotal >= 0 ? '+' : ''}$${std8hFundingTotal.toFixed(3)}</span></div>
                            <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(59,130,246,0.1);">
                                <div style="display:flex; justify-content:space-between; align-items:center; font-weight:700;">
                                    <span style="font-size:0.65rem; color:#888;">Net Profit</span>
                                    <div style="text-align:right;">
                                        <span style="font-size:0.8rem;" class="${makerProfit > 0 ? 'pos' : 'neg'}">$${makerProfit.toFixed(3)}</span>
                                        <span style="font-size:0.6rem; margin-left:4px; opacity:0.7;" class="${makerProfit > 0 ? 'pos' : 'neg'}">(${(makerProfit / tradeSize * 100).toFixed(2)}%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Taker Column (Orange) -->
                        <div style="padding:10px; background:rgba(249,115,22,0.03); border-radius:8px; border:1px solid rgba(249,115,22,0.08);">
                            <div style="font-size:0.65rem; font-weight:700; color:rgba(249,115,22,0.8); margin-bottom:8px;">TAKER (Market)</div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Fees (${longFees.taker}%+${shortFees.taker}%)√ó2</span><span class="mcb-val neg" style="font-size:0.7rem;">-$${takerFeeTotal.toFixed(3)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Price Diff</span><span class="mcb-val ${priceDiff > 0 ? 'pos' : 'neg'}" style="font-size:0.7rem;">${priceDiff >= 0 ? '+' : ''}$${priceDiff.toFixed(3)}</span></div>
                            <div class="mcb-row"><span class="mcb-lbl" style="font-size:0.6rem;">Funding (8h)</span><span class="mcb-val ${std8hFundingTotal >= 0 ? 'pos' : 'neg'}" style="font-size:0.7rem;">${std8hFundingTotal >= 0 ? '+' : ''}$${std8hFundingTotal.toFixed(3)}</span></div>
                            <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(249,115,22,0.1);">
                                <div style="display:flex; justify-content:space-between; align-items:center; font-weight:700;">
                                    <span style="font-size:0.65rem; color:#888;">Net Profit</span>
                                    <div style="text-align:right;">
                                        <span style="font-size:0.8rem;" class="${takerProfit > 0 ? 'pos' : 'neg'}">$${takerProfit.toFixed(3)}</span>
                                        <span style="font-size:0.6rem; margin-left:4px; opacity:0.7;" class="${takerProfit > 0 ? 'pos' : 'neg'}">(${(takerProfit / tradeSize * 100).toFixed(2)}%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                }).join('');
            },

            renderTRY: (v) => {
                const exchanges = state.tryData.length ? state.tryData : [];

                if (!exchanges.length || exchanges.every(ex => ex.bid === 0)) {
                    v.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.5;">
                        <div style="font-size:1.5rem; margin-bottom:10px;">‚Ç∫</div>
                        <div>Connecting to Turkish exchanges...</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:10px;">Binance TR, BTCTurk, OKX TR, Paribu</div>
                    </div>`;
                    return;
                }

                // Helper for decimal formatting (3 digits for Paribu/BTCTurk with smaller 3rd digit)
                const formatPrice = (price, name) => {
                    if (!price || price === 0) return '-';
                    if (name === 'Paribu' || name === 'BTCTurk') {
                        // 3 digits, but 3rd digit is smaller
                        const str = price.toFixed(3);
                        const parts = str.split('.');
                        const intPart = parts[0];
                        const decPart = parts[1] || '000';
                        return `${intPart}.${decPart.substring(0, 2)}<span style="font-size:0.7em;opacity:0.7;">${decPart.substring(2)}</span>`;
                    }
                    return price.toFixed(2);
                };

                // Helper for volume formatting (K for thousands, M for millions)
                const formatVolume = (vol) => {
                    if (!vol || vol === 0) return '-';
                    if (vol >= 1000000) return (vol / 1000000).toFixed(1) + 'M';
                    if (vol >= 1000) return (vol / 1000).toFixed(1) + 'K';
                    return vol.toFixed(0);
                };

                let h = `<div style="font-size:0.7rem; font-weight:800; color:#444; margin-bottom:10px; text-transform:uppercase;">USDT/TRY Live Orderbook</div>`;

                h += exchanges.map(ex => {
                    if (ex.bid === 0 && ex.ask === 0) return ''; // Skip empty data

                    const mid = ((ex.bid + ex.ask) / 2);
                    const spread = ex.bid > 0 ? ((ex.ask - ex.bid) / ex.bid * 100) : 0;

                    // Get bids and asks, fallback to single level if no depth
                    const bids = (ex.bids && ex.bids.length > 0) ? ex.bids.slice(0, 3) : [{ price: ex.bid, amount: 0 }];
                    const asks = (ex.asks && ex.asks.length > 0) ? ex.asks.slice(0, 3) : [{ price: ex.ask, amount: 0 }];

                    // Pad to 3 levels
                    while (bids.length < 3) bids.push({ price: 0, amount: 0 });
                    while (asks.length < 3) asks.push({ price: 0, amount: 0 });

                    return `<div class="try-card">
                        <div class="tc-h">
                            <span class="tc-t">${ex.name}</span>
                            <span class="tc-p">${formatPrice(mid, ex.name)} ‚Ç∫</span>
                        </div>
                        <div class="tc-d" style="gap:0;">
                            <!-- ASKS (Red) - Volume left, Price right (toward center) -->
                            <div style="border-right:1px solid #222;">
                                ${asks.map(a => a.price > 0 ? `
                                    <div class="tr ta" style="justify-content:space-between;">
                                        <span style="color:#666;">${formatVolume(a.amount)}</span>
                                        <span>${formatPrice(a.price, ex.name)}</span>
                                    </div>
                                ` : `<div class="tr" style="color:#333;">-</div>`).join('')}
                            </div>
                            <!-- BIDS (Green) - Price left (toward center), Volume right -->
                            <div>
                                ${bids.map(b => b.price > 0 ? `
                                    <div class="tr tb" style="justify-content:space-between;">
                                        <span>${formatPrice(b.price, ex.name)}</span>
                                        <span style="color:#666;">${formatVolume(b.amount)}</span>
                                    </div>
                                ` : `<div class="tr" style="color:#333;">-</div>`).join('')}
                            </div>
                        </div>
                        <div style="padding:4px 10px 10px; font-size:0.65rem; color:#555; display:flex; justify-content:space-between;">
                            <span>Spread: ${spread.toFixed(3)}%</span>
                            <span style="color:var(--neg);">ASK</span>
                            <span style="color:var(--pos);">BID</span>
                        </div>
                    </div>`;
                }).join('');

                // Arbitrage opportunities
                const validExchanges = exchanges.filter(ex => ex.bid > 0 && ex.ask > 0);
                if (validExchanges.length >= 2) {
                    h += `<div style="font-size:0.7rem; font-weight:800; color:#444; margin:20px 0 10px; text-transform:uppercase;">Arbitrage Opportunities</div>`;
                    const sorted = [...validExchanges].sort((a, b) => a.ask - b.ask);
                    const cheapest = sorted[0];
                    const expensive = sorted[sorted.length - 1];
                    const profit = ((expensive.bid - cheapest.ask) / cheapest.ask * 100);

                    h += `<div class="usdc-card">
                        <div class="usdc-header">
                            <span class="usdc-pair">Buy ${cheapest.name} ‚Üí Sell ${expensive.name}</span>
                            <span class="usdc-spread ${profit > 0 ? 'pos' : 'neg'}">${profit.toFixed(3)}%</span>
                        </div>
                        <div class="usdc-row"><span class="usdc-lbl">Buy Price (Ask)</span><span class="usdc-val">${formatPrice(cheapest.ask, cheapest.name)} ‚Ç∫</span></div>
                        <div class="usdc-row"><span class="usdc-lbl">Sell Price (Bid)</span><span class="usdc-val">${formatPrice(expensive.bid, expensive.name)} ‚Ç∫</span></div>
                        <div class="usdc-row"><span class="usdc-lbl">Gross Profit</span><span class="usdc-val ${profit > 0 ? 'pos' : 'neg'}">${profit.toFixed(3)}%</span></div>
                    </div>`;
                }

                v.innerHTML = h;
            },

            renderUSDC: (v) => {
                const pairs = state.usdcData.length ? state.usdcData : [
                    { exchange: 'Binance', pair: 'USDC/USDT', bid: 0.9998, ask: 1.0001 },
                    { exchange: 'OKX', pair: 'USDC/USDT', bid: 0.9997, ask: 1.0002 },
                    { exchange: 'Bybit', pair: 'USDC/USDT', bid: 0.9999, ask: 1.0001 }
                ];

                let h = `<div style="font-size:0.7rem; font-weight:800; color:#444; margin-bottom:10px; text-transform:uppercase;">USDC/USDT Prices</div>`;
                pairs.forEach(p => {
                    const spread = ((p.ask - p.bid) * 10000).toFixed(1);
                    h += `<div class="usdc-card">
                    <div class="usdc-header">
                        <span class="usdc-pair">${p.exchange}</span>
                        <span class="usdc-spread">${spread} bps</span>
                    </div>
                    <div class="usdc-row"><span class="usdc-lbl">Bid</span><span class="usdc-val pos">${p.bid.toFixed(4)}</span></div>
                    <div class="usdc-row"><span class="usdc-lbl">Ask</span><span class="usdc-val neg">${p.ask.toFixed(4)}</span></div>
                </div>`;
                });
                v.innerHTML = h;
            },

            renderSettings: (v) => {
                const exchanges = ['Binance', 'OKX', 'Bybit', 'Hyperliquid', 'Asterdex'];
                const defaultFees = {
                    Binance: { maker: 0.02, taker: 0.05 },
                    OKX: { maker: 0.02, taker: 0.05 },
                    Bybit: { maker: 0.02, taker: 0.055 },
                    Hyperliquid: { maker: 0.02, taker: 0.05 },
                    Asterdex: { maker: 0.01, taker: 0.03 }
                };

                // Load saved settings
                const saved = ui.loadSettings();
                const savedFees = saved?.fees || {};
                const savedTradeSize = saved?.tradeSize || 100;

                let h = `<div style="font-size:0.7rem; font-weight:800; color:#444; margin-bottom:20px; text-transform:uppercase;">Exchange Fee Settings</div>`;

                // Per-exchange fee cards
                exchanges.forEach(ex => {
                    const exKey = ex.toLowerCase();
                    const fees = savedFees[exKey] || defaultFees[ex];
                    h += `<div class="usdc-card" style="margin-bottom:12px;">
                        <div class="usdc-header" style="margin-bottom:12px;">
                            <span class="usdc-pair">${ex}</span>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label style="display:block; font-size:0.65rem; color:#666; margin-bottom:4px;">Maker (%)</label>
                                <input type="number" id="fee-${exKey}-maker" value="${fees.maker}" step="0.001" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; font-family:var(--font-mono); font-size:0.8rem;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.65rem; color:#666; margin-bottom:4px;">Taker (%)</label>
                                <input type="number" id="fee-${exKey}-taker" value="${fees.taker}" step="0.001" style="width:100%; padding:8px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; font-family:var(--font-mono); font-size:0.8rem;">
                            </div>
                        </div>
                    </div>`;
                });

                // Trade size
                h += `<div class="usdc-card" style="margin-bottom:12px; margin-top:20px;">
                    <div style="font-size:0.7rem; font-weight:700; color:#888; margin-bottom:10px;">Trade Configuration</div>
                    <div>
                        <label style="display:block; font-size:0.65rem; color:#666; margin-bottom:4px;">Trade Size (USD)</label>
                        <input type="number" id="trade-size" value="${savedTradeSize}" step="10" style="width:100%; padding:10px; background:#1a1a1a; border:1px solid #333; border-radius:6px; color:#fff; font-family:var(--font-mono);">
                    </div>
                </div>`;

                h += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <button onclick="ui.saveSettings()" style="padding:14px; background:var(--text-accent); border:none; border-radius:8px; color:#000; font-weight:700; font-size:0.9rem; cursor:pointer;">Save Settings</button>
                    <button onclick="ui.resetSettings()" style="padding:14px; background:#333; border:1px solid #444; border-radius:8px; color:#fff; font-weight:700; font-size:0.9rem; cursor:pointer;">Reset to Defaults</button>
                </div>`;
                h += `<div id="settings-status" style="text-align:center; font-size:0.75rem; color:#666; margin-top:10px;"></div>`;

                v.innerHTML = h;
            },

            saveSettings: () => {
                const exchanges = ['binance', 'okx', 'bybit', 'hyperliquid', 'asterdex'];
                const settings = { fees: {}, tradeSize: 100 };

                exchanges.forEach(ex => {
                    const maker = parseFloat(document.getElementById(`fee-${ex}-maker`)?.value) || 0.02;
                    const taker = parseFloat(document.getElementById(`fee-${ex}-taker`)?.value) || 0.05;
                    settings.fees[ex] = { maker, taker };
                });
                settings.tradeSize = parseFloat(document.getElementById('trade-size')?.value) || 100;

                localStorage.setItem('rbit-settings', JSON.stringify(settings));
                document.getElementById('settings-status').textContent = '‚úì Settings saved!';
                setTimeout(() => {
                    document.getElementById('settings-status').textContent = '';
                }, 2000);
            },

            loadSettings: () => {
                try {
                    const saved = localStorage.getItem('rbit-settings');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                } catch (e) { }
                return null;
            },

            resetSettings: () => {
                localStorage.removeItem('rbit-settings');
                document.getElementById('settings-status').textContent = '‚úì Reset to defaults!';
                // Re-render settings page with defaults
                setTimeout(() => {
                    ui.renderSettings(document.getElementById('mainView'));
                }, 500);
            },

            updateLiveData: () => {
                if (state.tab === 'try') ui.renderTRY(document.getElementById('mainView'));
                if (state.tab === 'usdc') ui.renderUSDC(document.getElementById('mainView'));
            }
        };

        const app = {
            connect: () => {
                const ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host);
                ws.onmessage = e => {
                    try {
                        const m = JSON.parse(e.data);
                        if (m.type === 'ARBITRAGE_UPDATE') {
                            state.data = m.data;
                            if (m.allData) state.allData = m.allData;
                            if (m.tryData) state.tryData = m.tryData;
                            if (m.usdcData) state.usdcData = m.usdcData;
                            if (state.tab === 'funding') ui.render();
                        }
                    } catch (e) { }
                };
                ws.onclose = () => setTimeout(app.connect, 2000);
            }
        };
        window.onload = ui.init;
    </script>
</body>

</html>