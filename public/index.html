<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rbit Terminal</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">


    <style>
        :root {
            --bg: #050505;
            --card-bg: #111;
            --text: #e0e0e0;
            --accent: #F7931A;
            --pos: #00E676;
            --neg: #FF3D00;
            --binance: #FCD535;
            --okx: #fff;
            --bybit: #FFB119;
            --hl: #00D4FF;
            --aster: #A088FF;
            --border: #222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 1px solid var(--border);
            background: #080808;
            z-index: 50;
        }

        .logo {
            font-weight: 800;
            font-size: 1.1rem;
            color: #fff;
        }

        .logo span {
            color: var(--accent);
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #fff;
            display: none;
        }

        /* LAYOUT */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: #0a0a0a;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* MOBILE SIDEBAR */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 101;
                transform: translateX(-100%);
                transition: 0.2s;
                padding-top: 50px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .overlay.active {
                display: block;
            }

            .menu-btn {
                display: block;
            }
        }

        /* SIDEBAR ITEMS */
        .sb-sec {
            padding: 15px;
            border-bottom: 1px solid #1a1a1a;
        }

        .sb-head {
            font-size: 0.75rem;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .sb-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            background: transparent;
            border: none;
            color: #bbb;
            font-size: 0.9rem;
            margin-bottom: 2px;
            border-radius: 4px;
        }

        .sb-btn.active {
            background: #1a1a1a;
            color: var(--accent);
            font-weight: 700;
        }

        /* --- ALL DATA TABLE --- */
        .coin-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
            display: table;
        }

        .ct-head th {
            text-align: right;
            padding: 10px;
            font-size: 0.75rem;
            border-bottom: 1px solid #333;
            color: #666;
            font-weight: 800;
        }

        .ct-head th:first-child {
            text-align: left;
        }

        .ct-row td {
            padding: 12px;
            border-bottom: 1px solid #1a1a1a;
            vertical-align: middle;
        }

        .ct-sym {
            font-weight: 800;
            color: #fff;
            font-size: 0.95rem;
        }

        .ct-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .ct-fund {
            font-family: 'JetBrains Mono';
            font-size: 0.85rem;
            font-weight: 700;
            color: #ddd;
        }

        .ct-price {
            font-family: 'JetBrains Mono';
            font-size: 0.7rem;
            color: #555;
        }

        /* ALL OPPS ROW */
        .opp-row {
            background: #111;
            border: 1px solid #222;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr auto;
            gap: 12px;
            align-items: center;
        }

        .or-sym {
            font-weight: 800;
            font-size: 1rem;
            color: #fff;
        }

        .or-info {
            display: flex;
            flex-direction: column;
            font-size: 0.75rem;
            gap: 2px;
        }

        .or-apr {
            text-align: right;
            font-weight: 900;
            color: var(--accent);
            font-size: 1rem;
        }

        /* TRY ARB */
        .try-card {
            background: #121212;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .tc-head {
            padding: 12px 16px;
            background: #181818;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .tc-title {
            font-weight: 700;
            color: #fff;
            font-size: 0.95rem;
        }

        .tc-price {
            font-family: 'JetBrains Mono';
            font-weight: 700;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .tc-depth {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .depth-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'JetBrains Mono';
            font-size: 0.75rem;
            margin-bottom: 2px;
        }

        .depth-row.bid {
            background: rgba(0, 230, 118, 0.08);
            color: #00E676;
        }

        .depth-row.ask {
            background: rgba(255, 61, 0, 0.08);
            color: #FF3D00;
        }

        /* NAV */
        .nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 60px;
            background: #080808;
            border-top: 1px solid #222;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            background: none;
            border: none;
            color: #555;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            opacity: 0.7;
            transition: 0.2s;
        }

        .nav-item.active {
            color: var(--accent);
            opacity: 1;
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 1.2rem;
        }
    </style>

</head>

<body>
    <div class="overlay" onclick="ui.toggle(false)"></div>
    <div class="layout" style="height:100vh; padding-top:50px; padding-bottom:60px;">
        <header class="header" style="position:fixed; top:0; width:100%;">
            <div class="logo">R<span>bit</span></div>
            <button class="menu-btn" id="mainMenuBtn" onclick="ui.toggle(true)">‚ò∞</button>
        </header>

        <aside class="sidebar" id="sidebar">
            <div id="sbContent"></div>
        </aside>

        <main class="main" id="mainView"></main>

        <nav class="nav">
            <button class="nav-item active" onclick="ui.nav('funding')"><span class="nav-icon">üìä</span>Funding</button>
            <button class="nav-item" onclick="ui.nav('try')"><span class="nav-icon">‚Ç∫</span>TRY Arb</button>
            <button class="nav-item" onclick="ui.nav('usdc')"><span class="nav-icon">üí≤</span>USDC</button>
            <button class="nav-item" onclick="ui.nav('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
        </nav>
    </div>


    <script>
        const PAIR_GROUPS = [
            { t: 'Overview', i: [{ id: 'all-opps', l: 'All Opportunities' }, { id: 'all-coins', l: 'All Data (Table)' }] },
            { t: 'Binance Pairs', i: [{ id: 'binance-okx', l: 'Binance <> OKX' }, { id: 'binance-bybit', l: 'Binance <> Bybit' }, { id: 'binance-hyperliquid', l: 'Binance <> HL' }, { id: 'binance-asterdex', l: 'Binance <> Aster' }] },
            { t: 'OKX Pairs', i: [{ id: 'okx-bybit', l: 'OKX <> Bybit' }, { id: 'okx-hyperliquid', l: 'OKX <> HL' }, { id: 'okx-asterdex', l: 'OKX <> Aster' }] },
            { t: 'Bybit Pairs', i: [{ id: 'bybit-hyperliquid', l: 'Bybit <> HL' }, { id: 'bybit-asterdex', l: 'Bybit <> Aster' }] }
        ];

        const state = { tab: 'funding', filter: 'all-opps', data: {}, allData: [], wsConnected: false };

        const ui = {
            init: () => {
                ui.buildSidebar();
                ui.nav('funding');
                app.connect();
                setInterval(ui.updateTryData, 2000);
            },

            nav: (t) => {
                state.tab = t;
                const menuBtn = document.getElementById('mainMenuBtn');
                const sb = document.getElementById('sidebar');

                // 1. Sidebar Visibility Logic
                if (t === 'funding') {
                    menuBtn.style.display = 'block';
                    // On desktop, sidebar is always visible via flex layout if user wants, 
                    // but we should ensure it's interactable.
                } else {
                    menuBtn.style.display = 'none';
                    ui.toggle(false); // Close mobile sidebar if open
                }

                // 2. Nav Active State
                document.querySelectorAll('.nav-item').forEach((b, i) => b.classList.toggle('active', ['funding', 'try', 'usdc', 'settings'][i] === t));
                ui.render();
            },

            toggle: (s) => {
                const sb = document.getElementById('sidebar');
                const ov = document.querySelector('.overlay');
                if (s) { sb.classList.add('active'); ov.classList.add('active'); }
                else { sb.classList.remove('active'); ov.classList.remove('active'); }
            },

            buildSidebar: () => {
                let h = '';
                PAIR_GROUPS.forEach(g => {
                    h += `<div class="sb-sec"><div class="sb-head">${g.t}</div>`;
                    g.i.forEach(it => {
                        h += `<button class="sb-btn" id="btn-${it.id}" onclick="ui.setFilter('${it.id}')">${it.l}</button>`;
                    });
                    h += `</div>`;
                });
                document.getElementById('sbContent').innerHTML = h;
            },

            setFilter: (f) => {
                state.filter = f;
                ui.toggle(false);
                ui.render();
            },

            render: () => {
                const v = document.getElementById('mainView');
                if (state.tab !== 'funding') {
                    if (state.tab === 'try') ui.renderTRY(v);
                    else v.innerHTML = `<div style="padding:40px;text-align:center;color:#666;">Coming Soon: ${state.tab}</div>`;
                    return;
                }

                document.querySelectorAll('.sb-btn').forEach(b => b.classList.remove('active'));
                const b = document.getElementById('btn-' + state.filter);
                if (b) b.classList.add('active');

                if (state.filter === 'all-coins') return ui.renderAllCoins(v);
                if (state.filter === 'all-opps') return ui.renderAllOpps(v);
                ui.renderDetailed(v);
            },

            formatTime: (ms) => {
                if (!ms) return '8h 00m';
                const diff = ms - Date.now();
                if (diff <= 0) return 'Funding...';
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                return `${h}h ${m}m`;
            },

            renderAllCoins: (v) => {
                if (!state.allData.length) { v.innerHTML = '<div style="padding:20px;">Loading Data...</div>'; return; }
                const sorted = [...state.allData].sort((a, b) => a.symbol.localeCompare(b.symbol));

                const cell = (ex) => {
                    if (!ex || !ex.price) return `<div class="ct-cell"><span class="ct-price">-</span></div>`;
                    const fundVal = Number(ex.funding || 0);
                    const fundStr = isNaN(fundVal) ? '0.0000%' : (fundVal * 100).toFixed(4) + '%';
                    const pClass = fundVal > 0 ? 'pos' : (fundVal < 0 ? 'neg' : '');

                    return `<div class="ct-cell">
                    <span class="ct-fund ${pClass}">${fundStr}</span>
                    <span class="ct-price">${Number(ex.price || 0).toFixed(4)}</span>
                </div>`;
                };

                let h = `<div style="overflow-x:auto;"><table class="coin-table">
            <thead class="ct-head"><tr>
                <th>COIN</th>
                <th style="color:var(--binance)">BINANCE</th>
                <th style="color:var(--okx)">OKX</th>
                <th style="color:var(--bybit)">BYBIT</th>
                <th style="color:var(--hl)">HYPER</th>
                <th style="color:var(--aster)">ASTER</th>
            </tr></thead><tbody>`;
                sorted.forEach(c => {
                    h += `<tr class="ct-row">
                    <td class="ct-sym">${c.symbol}</td>
                    <td>${cell(c.binance)}</td>
                    <td>${cell(c.okx)}</td>
                    <td>${cell(c.bybit)}</td>
                    <td>${cell(c.hyperliquid)}</td>
                    <td>${cell(c.asterdex)}</td>
                </tr>`;
                });
                h += `</tbody></table></div>`;
                v.innerHTML = h;
            },

            renderAllOpps: (v) => {
                let list = [];
                Object.values(state.data).forEach(a => { if (Array.isArray(a)) list.push(...a); });
                if (!list.length) { v.innerHTML = '<div style="padding:20px;">Scanning Opportunities...</div>'; return; }

                list.sort((a, b) => (b.analysis?.annualAPR || 0) - (a.analysis?.annualAPR || 0));
                list = list.slice(0, 50);

                let h = '<div style="font-size:0.7rem; font-weight:800; color:#555; margin-bottom:12px; padding:0 5px; text-transform:uppercase;">Top Opportunities Global</div>';
                list.forEach(d => {
                    const an = d.analysis || {};

                    let openLong = {}, openShort = {};
                    if (an.strategy === 'LONG_A_SHORT_B') {
                        openLong = d.exchangeA; openShort = d.exchangeB;
                    } else {
                        openLong = d.exchangeB; openShort = d.exchangeA;
                    }

                    const lf = Number(openLong.fundingRate || 0) * 100;
                    const sf = Number(openShort.fundingRate || 0) * 100;

                    h += `<div class="opp-row">
                    <div class="or-sym">${d.symbol}</div>
                    <div class="or-info">
                        <div style="color:var(--pos); font-weight:700;">L: ${openLong.name}</div>
                        <div class="or-val">${Number(openLong.markPrice || 0).toFixed(4)}</div>
                        <div class="or-fund ${lf > 0 ? 'pos' : 'neg'}">${lf.toFixed(4)}%</div>
                    </div>
                    <div class="or-info">
                        <div style="color:var(--neg); font-weight:700;">S: ${openShort.name}</div>
                        <div class="or-val">${Number(openShort.markPrice || 0).toFixed(4)}</div>
                        <div class="or-fund ${sf > 0 ? 'pos' : 'neg'}">${sf.toFixed(4)}%</div>
                    </div>
                    <div class="or-apr">${(an.annualAPR || 0).toFixed(0)}%</div>
                </div>`;
                });
                v.innerHTML = h;
            },

            renderDetailed: (v) => {
                const list = (state.data[state.filter] || []).sort((a, b) => (b.analysis?.annualAPR || 0) - (a.analysis?.annualAPR || 0)).slice(0, 10);
                if (!list.length) { v.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.6;">Waiting for data... <br><small>${state.filter}</small></div>`; return; }

                v.innerHTML = list.map(d => {
                    const an = d.analysis || {};

                    let openLong = {}, openShort = {};
                    if (an.strategy === 'LONG_A_SHORT_B') {
                        openLong = d.exchangeA; openShort = d.exchangeB;
                    } else {
                        openLong = d.exchangeB; openShort = d.exchangeA;
                    }

                    const fees = an.fees || {};
                    const makerFee = (an.tradeSize || 100) * 0.0002; // Simulating Maker 0.02%
                    const takerFee = (an.tradeSize || 100) * 0.0005; // Simulating Taker 0.05%

                    const pProfit = an.priceDiffPnL || 0;
                    const fundingProfit = an.fundingIncomeCycle || 0;
                    const netProfit = an.netCycleProfit || 0;

                    const lf = Number(openLong.fundingRate || 0) * 100;
                    const sf = Number(openShort.fundingRate || 0) * 100;

                    const tLong = ui.formatTime(openLong.nextFundingTime);
                    const tShort = ui.formatTime(openShort.nextFundingTime);

                    return `<div class="master-card">
                    <div class="mc-header">
                        <div>
                            <div class="mc-title">${d.symbol}</div>
                            <div class="mc-profit-sub">Next Cycle Profit: <span style="color:#fff; font-family:'JetBrains Mono';">$${netProfit.toFixed(4)}</span></div>
                        </div>
                        <div class="mc-apr-box">
                            <div class="mc-apr-val">${(an.annualAPR || 0).toFixed(0)}%</div>
                            <div class="mc-apr-lbl">Annual APR</div>
                        </div>
                    </div>
                    
                    <div class="mc-sides">
                        <div class="mc-side left">
                            <span class="mc-role long">LONG POSITION</span>
                            <div class="mc-ex-row">
                                <span class="mc-ex-name">${openLong.name}</span>
                                <span class="mc-price">${Number(openLong.markPrice || 0).toFixed(4)}</span>
                            </div>
                            <div class="mc-meta-row">
                                <span>Funding:</span>
                                <span class="mc-fund ${lf > 0 ? 'pos' : 'neg'}">${lf.toFixed(4)}%</span>
                            </div>
                            <div class="mc-meta-row" style="margin-top:2px;">
                                <span>Interval:</span>
                                <span>${tLong}</span>
                            </div>
                        </div>
                        <div class="mc-side">
                            <span class="mc-role short">SHORT POSITION</span>
                            <div class="mc-ex-row">
                                <span class="mc-ex-name">${openShort.name}</span>
                                <span class="mc-price">${Number(openShort.markPrice || 0).toFixed(4)}</span>
                            </div>
                            <div class="mc-meta-row">
                                <span>Funding:</span>
                                <span class="mc-fund ${sf > 0 ? 'pos' : 'neg'}">${sf.toFixed(4)}%</span>
                            </div>
                             <div class="mc-meta-row" style="margin-top:2px;">
                                <span>Interval:</span>
                                <span>${tShort}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mc-table">
                        <div class="mc-row">
                            <div class="mc-item">
                                <span class="mc-lbl">Maker Fee</span>
                                <span class="mc-val neg">-$${makerFee.toFixed(3)}</span>
                            </div>
                             <div class="mc-item">
                                <span class="mc-lbl">Taker Fee</span>
                                <span class="mc-val neg">-$${takerFee.toFixed(3)}</span>
                            </div>
                        </div>
                        <div class="mc-row full">
                             <div class="mc-item">
                                <span class="mc-lbl">Price Difference Profit</span>
                                <span class="mc-val ${pProfit > 0 ? 'pos' : 'neg'}">${pProfit > 0 ? '+' : ''}$${pProfit.toFixed(3)}</span>
                            </div>
                        </div>
                         <div class="mc-row full">
                             <div class="mc-item">
                                <span class="mc-lbl">Next Cycle Funding Profit</span>
                                <span class="mc-val pos">+$${fundingProfit.toFixed(3)}</span>
                            </div>
                        </div>
                         <div class="mc-row full">
                             <div class="mc-item">
                                <span class="mc-lbl">Closing Fee (Est)</span>
                                <span class="mc-val neg">-$${(takerFee + makerFee).toFixed(3)}</span>
                            </div>
                        </div>
                        
                        <div class="mc-total">
                            <span class="mc-total-lbl">NET PROFIT</span>
                            <span class="mc-total-val ${netProfit > 0 ? 'pos' : 'neg'}">${netProfit.toFixed(4)}%</span>
                        </div>
                    </div>
                </div>`;
                }).join('');
            },

            renderTRY: (v) => {
                const pairs = [
                    { n: 'Binance TR', p: 35.84 }, { n: 'Paribu', p: 35.92 },
                    { n: 'OKX TR', p: 35.82 }, { n: 'Bybit TR', p: 35.80 }
                ];

                let h = `<div style="padding:16px 16px 0 16px; font-weight:800; color:#444; font-size:0.8rem; text-transform:uppercase;">USDT/TRY Live Market</div>`;
                h += pairs.map(p => {
                    const spread = 0.05;
                    const ask = p.p + Math.random() * 0.04;
                    const bid = p.p - Math.random() * 0.04;

                    return `
                <div class="try-card">
                    <div class="tc-head">
                        <span class="tc-title">${p.n}</span>
                        <span class="tc-price">${p.p.toFixed(2)} ‚Ç∫</span>
                    </div>
                    <div class="tc-depth">
                        <div class="depth-col">
                           <div class="depth-row bid"><span>${(bid - 0.01).toFixed(2)}</span><span>12.5K</span></div>
                           <div class="depth-row bid"><span>${(bid - 0.03).toFixed(2)}</span><span>8.2K</span></div>
                           <div class="depth-row bid"><span>${(bid - 0.05).toFixed(2)}</span><span>25.1K</span></div>
                        </div>
                        <div class="depth-col">
                           <div class="depth-row ask"><span>2.4K</span><span>${(ask + 0.01).toFixed(2)}</span></div>
                           <div class="depth-row ask"><span>5.1K</span><span>${(ask + 0.03).toFixed(2)}</span></div>
                           <div class="depth-row ask"><span>9.8K</span><span>${(ask + 0.05).toFixed(2)}</span></div>
                        </div>
                    </div>
                </div>`;
                }).join('');
                v.innerHTML = h;
            },

            updateTryData: () => {
                if (state.tab === 'try') ui.renderTRY(document.getElementById('mainView'));
            }
        };

        const app = {
            connect: () => {
                const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${proto}//${window.location.host}`);
                ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'ARBITRAGE_UPDATE') {
                            state.data = msg.data;
                            if (msg.allData) state.allData = msg.allData;
                            if (state.tab === 'funding') ui.render();
                        }
                    } catch (e) { }
                };
                ws.onclose = () => setTimeout(app.connect, 2000);
            }
        };
        window.onload = ui.init;
    </script>
</body>

</html>